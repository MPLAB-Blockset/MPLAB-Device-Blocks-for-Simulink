<!DOCTYPE html>
<html>
<head>
    <title>MCHP Op-Amp - MCHP Blockset Documentation</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../assets/css/navigation.css">
    <script src="../../assets/js/navigation.js"></script>
</head>
<body>
    <!-- Mobile Navigation Toggle -->
    <button class="nav-toggle" aria-label="Toggle navigation">☰</button>

    <!-- Left Navigation Panel -->
    <nav class="doc-nav-container">
        <div class="doc-nav-header">
            <a href="../../index.html">MCHP Blockset Docs</a>
        </div>
        <ul class="doc-nav-menu">
            <li class="nav-item">
                <a href="../../index.html" class="nav-link">Home</a>
            </li>

            <!-- Getting Started Section -->
            <li class="nav-item">
                <div class="nav-category">Getting Started <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../getting_started/overview.html" class="nav-link">Overview</a></li>
                    <li><a href="../../getting_started/installation.html" class="nav-link">Installation</a></li>
                    <li><a href="../../getting_started/quick_start.html" class="nav-link">Quick Start</a></li>
                    <li><a href="../../getting_started/board_templates.html" class="nav-link">Board Templates</a></li>
                    <li><a href="../../getting_started/supported_devices.html" class="nav-link">Supported Devices</a></li>
                </ul>
            </li>

            <!-- User Guide Section -->
            <li class="nav-item">
                <div class="nav-category">User Guide <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../user_guide/index.html" class="nav-link">User Guide Overview</a></li>
                    <li><a href="../../user_guide/code_generation.html" class="nav-link">Code Generation</a></li>
                    <li><a href="../../user_guide/external_mode.html" class="nav-link">External Mode</a></li>
                </ul>
            </li>

            <!-- Block Reference Section -->
            <li class="nav-item">
                <div class="nav-category">Block Reference <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../block_reference/index.html" class="nav-link">Block Reference Overview</a></li>
                </ul>
            </li>

            <!-- Examples Section -->
            <li class="nav-item">
                <div class="nav-category">Examples <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../examples/field_weakening.html" class="nav-link">Field Weakening</a></li>
                </ul>
            </li>

            <!-- Release Notes -->
            <li class="nav-item">
                <a href="../../release_notes.html" class="nav-link">Release Notes</a>
            </li>
        </ul>
    </nav>

    <div class="doc-content-wrapper">
    <div class="header">
        <h1>MCHP_OP_AMP - Operational Amplifier</h1>
        <p>Integrated operational amplifiers for signal conditioning and analog processing</p>
    </div>

    <div class="breadcrumb">
        <a href="../../index.html">Home</a>
        <span>›</span>
        <a href="../index.html">Block Reference</a>
        <span>›</span>
        <a href="analog.html">Analog Blocks</a>
        <span>›</span>
        <span>Op-Amp</span>
    </div>

    <div class="container">
        <div class="content-card">
            
    <!-- Block Icon -->
    <div class="block-image">
        <img src="../assets/images/blocks/analog/OpAmp.svg"
             alt="OpAmp Block Icon"
             onerror="this.onerror=null; this.src='../assets/images/blocks/analog/OpAmp.png';">
        <div class="block-image-caption">
            OpAmp Block Icon
        </div>
    </div>
<h2>Block Overview</h2>
            <p>
                The <strong>MCHP_OP_AMP</strong> block provides access to the integrated operational amplifiers available in dsPIC33C,
                dsPIC33CH, and dsPIC33CK microcontrollers. These on-chip op-amps eliminate the need for external amplification
                circuitry in many applications, reducing BOM cost and board space while improving signal integrity.
            </p>

            <div class="note">
                <strong>Key Benefits:</strong>
                <ul>
                    <li>Integrated signal conditioning eliminates external op-amps</li>
                    <li>Direct connection to ADC for optimized signal chain</li>
                    <li>Configurable gain settings for flexible amplification</li>
                    <li>Rail-to-rail operation for maximum dynamic range</li>
                    <li>Low offset and drift for precision measurements</li>
                </ul>
            </div>

            <h3>Supported Device Families</h3>
            <table class="parameter-table">
                <tr>
                    <th>Family</th>
                    <th>DOS Module</th>
                    <th>Op-Amp Instances</th>
                    <th>Key Features</th>
                </tr>
                <tr>
                    <td><strong>dsPIC33C/CH/CK</strong></td>
                    <td><code>DOS_03349_amp_pad_opamp_ctrl_upb_v1</code></td>
                    <td>Up to 3 op-amps</td>
                    <td>Basic amplification, fixed gain</td>
                </tr>
                <tr>
                    <td><strong>dsPIC33A</strong></td>
                    <td><code>DOS_03495_amp_pad_opamp_ctrl_upb_v2_dspic33a</code></td>
                    <td>Up to 3 op-amps</td>
                    <td>Enhanced features, programmable gain</td>
                </tr>
            </table>

            <div class="info">
                <strong>Pin Mapping:</strong> The block automatically displays pin assignments for each op-amp instance (IN+, IN-, OUT)
                based on the selected device. Pin assignments are fixed in hardware and cannot be remapped.
            </div>
        </div>

        <div class="content-card">
            <h2>Operating Modes</h2>

            <h3>1. Voltage Follower (Buffer)</h3>
            <div class="example">
                <strong>Configuration:</strong> Enabled with negative input internally set to 0
                <ul>
                    <li><strong>Gain:</strong> Unity (1×)</li>
                    <li><strong>Input:</strong> IN+ connected to signal source</li>
                    <li><strong>Feedback:</strong> Output internally connected to IN-</li>
                    <li><strong>Use Case:</strong> High-impedance buffer, isolation amplifier</li>
                </ul>
            </div>

            <h3>2. Non-Inverting Amplifier</h3>
            <div class="example">
                <strong>Configuration:</strong> Enabled with positive and negative inputs
                <ul>
                    <li><strong>Gain:</strong> Configured by external resistor network</li>
                    <li><strong>Input:</strong> Signal applied to IN+</li>
                    <li><strong>Feedback:</strong> Resistor divider on IN- for gain setting</li>
                    <li><strong>Use Case:</strong> Signal amplification, sensor conditioning</li>
                </ul>
            </div>

            <h3>3. Inverting Amplifier</h3>
            <div class="example">
                <strong>Configuration:</strong> Enabled with positive and negative inputs
                <ul>
                    <li><strong>Gain:</strong> Set by input/feedback resistor ratio</li>
                    <li><strong>Input:</strong> Signal applied to IN- through input resistor</li>
                    <li><strong>Reference:</strong> IN+ connected to ground or reference voltage</li>
                    <li><strong>Use Case:</strong> Phase inversion, current-to-voltage conversion</li>
                </ul>
            </div>

            <h3>4. Differential Amplifier</h3>
            <div class="example">
                <strong>Configuration:</strong> Enabled with positive and negative inputs
                <ul>
                    <li><strong>Gain:</strong> Matched resistor network for CMRR</li>
                    <li><strong>Input:</strong> Differential signal on IN+ and IN-</li>
                    <li><strong>Output:</strong> Single-ended amplified difference</li>
                    <li><strong>Use Case:</strong> Differential sensor signals, noise rejection</li>
                </ul>
            </div>
        </div>

        <div class="content-card">
            <h2>Block Parameters</h2>

            <table class="parameter-table">
                <tr>
                    <th>Parameter</th>
                    <th>Options</th>
                    <th>Description</th>
                </tr>
                <tr>
                    <td><strong>OpAmp1</strong></td>
                    <td>
                        • Disabled<br>
                        • Enabled with negative input internally set to 0<br>
                        • Enabled with positive and negative inputs
                    </td>
                    <td>
                        Configuration for first op-amp instance. When enabled, the block automatically
                        configures AMPON (master enable) and AMPEN[0] (instance enable) bits. The mode
                        selection determines NCHDIS[0] setting (0 = internal connection, 1 = external pins).
                    </td>
                </tr>
                <tr>
                    <td><strong>OpAmp2</strong></td>
                    <td>
                        • Disabled<br>
                        • Enabled with negative input internally set to 0<br>
                        • Enabled with positive and negative inputs
                    </td>
                    <td>
                        Configuration for second op-amp instance. Independent control of AMPEN[1] and
                        NCHDIS[1] bits. Can be used simultaneously with OpAmp1 for dual-channel applications.
                    </td>
                </tr>
                <tr>
                    <td><strong>OpAmp3</strong></td>
                    <td>
                        • Disabled<br>
                        • Enabled with negative input internally set to 0<br>
                        • Enabled with positive and negative inputs
                    </td>
                    <td>
                        Configuration for third op-amp instance (if available on device). Controls AMPEN[2]
                        and NCHDIS[2]. Useful for three-phase motor control or multi-channel data acquisition.
                    </td>
                </tr>
            </table>

            <div class="warning">
                <strong>Important:</strong> Pin assignments for IN+, IN-, and OUT are device-specific and displayed
                in the block mask. Verify pin locations in the device datasheet before PCB layout. Some devices may
                not have all three op-amp instances available.
            </div>
        </div>

        <div class="content-card">
            <h2>Register Configuration</h2>

            <h3>AMPCON1 Register</h3>
            <div class="code-block">
// Op-Amp Control Register 1
AMPCON1 = (AMPON &lt;&lt; 15) |      // Master enable (1 = enabled)
          (AMPSIDL &lt;&lt; 13) |     // Stop in idle (0 = continue in idle)
          (NCHDIS2 &lt;&lt; 10) |     // OpAmp3 negative channel (1 = external pin)
          (NCHDIS1 &lt;&lt; 9) |      // OpAmp2 negative channel (1 = external pin)
          (NCHDIS0 &lt;&lt; 8) |      // OpAmp1 negative channel (1 = external pin)
          (AMPEN2 &lt;&lt; 2) |       // OpAmp3 enable (1 = enabled)
          (AMPEN1 &lt;&lt; 1) |       // OpAmp2 enable (1 = enabled)
          (AMPEN0 &lt;&lt; 0);        // OpAmp1 enable (1 = enabled)
            </div>

            <h3>Port Configuration</h3>
            <div class="code-block">
// Automatic analog pin configuration when op-amp enabled
// Example for OpAmp1:
if (AMPEN0) {
    TRISx_OA1OUT = 0;     // Output pin configured as output
    ANSELx_OA1OUT = 1;    // Analog mode for output

    TRISx_OA1INP = 1;     // IN+ configured as input
    ANSELx_OA1INP = 1;    // Analog mode for IN+

    if (NCHDIS0) {
        TRISx_OA1INM = 1; // IN- as input (external connection)
        ANSELx_OA1INM = 1; // Analog mode for IN-
    }
    // If NCHDIS0 = 0, IN- is internally connected (no pin config needed)
}
            </div>

            <div class="info">
                <strong>Automatic Configuration:</strong> The MCHP_PORT field in the block automatically handles
                all pin direction and analog/digital mode settings based on your op-amp configuration. You do not
                need to manually configure TRIS or ANSEL registers.
            </div>
        </div>

        <div class="content-card">
            <h2>Application Examples</h2>

            <h3>Example 1: Voltage Follower for ADC Input Buffering</h3>
            <div class="example">
                <strong>Application:</strong> High-impedance sensor buffer
                <div class="code-block">
// Configuration:
// - OpAmp1 = "Enabled with negative input internally set to 0"
// - OpAmp2 = Disabled
// - OpAmp3 = Disabled

// Hardware connections:
// - Sensor output → OA1_IN+ (high impedance input)
// - OA1_OUT → ADC channel (low impedance)
// - Feedback is internal (unity gain)

// Block automatically configures:
AMPCON1bits.AMPON = 1;      // Enable op-amp module
AMPCON1bits.AMPEN0 = 1;     // Enable OpAmp1
AMPCON1bits.NCHDIS0 = 0;    // Internal feedback (voltage follower)

// Result: Buffered sensor signal with no loading effect
                </div>
            </div>

            <h3>Example 2: Non-Inverting Amplifier (Gain = 10)</h3>
            <div class="example">
                <strong>Application:</strong> Thermocouple amplification
                <div class="code-block">
// Configuration:
// - OpAmp1 = "Enabled with positive and negative inputs"
// - External resistors: R1 = 1kΩ (to GND), R2 = 9kΩ (feedback)
// - Gain = 1 + (R2/R1) = 1 + (9k/1k) = 10

// Hardware connections:
// - Thermocouple → OA1_IN+
// - OA1_OUT → R2 → OA1_IN-
// - OA1_IN- → R1 → GND
// - OA1_OUT → ADC channel

// Block configuration:
AMPCON1bits.AMPON = 1;      // Enable op-amp module
AMPCON1bits.AMPEN0 = 1;     // Enable OpAmp1
AMPCON1bits.NCHDIS0 = 1;    // External pin for feedback network

// Result: 10× amplified thermocouple signal
// Input: 5mV → Output: 50mV
                </div>
            </div>

            <h3>Example 3: Differential Amplifier for Current Sensing</h3>
            <div class="example">
                <strong>Application:</strong> High-side current measurement
                <div class="code-block">
// Configuration:
// - OpAmp1 = "Enabled with positive and negative inputs"
// - Shunt resistor: 0.01Ω (100mΩ)
// - Matched resistor network: R1 = R3 = 1kΩ, R2 = R4 = 10kΩ
// - Differential gain = 10

// Hardware connections:
// - Motor high-side → Shunt (0.01Ω) → Motor
// - Shunt_High → R1 → OA1_IN+
// - Shunt_Low → R3 → GND
// - OA1_IN+ → R2 → OA1_OUT
// - OA1_IN- → R4 → GND
// - OA1_OUT → ADC

// Block configuration:
AMPCON1bits.AMPON = 1;      // Enable op-amp module
AMPCON1bits.AMPEN0 = 1;     // Enable OpAmp1
AMPCON1bits.NCHDIS0 = 1;    // External resistor network

// Current measurement:
// Motor current: 10A → Shunt voltage: 100mV
// Op-amp output: 100mV × 10 = 1V → ADC
                </div>
            </div>

            <h3>Example 4: Multi-Channel Instrumentation Amplifier</h3>
            <div class="example">
                <strong>Application:</strong> Three-phase current sensing
                <div class="code-block">
// Configuration:
// - OpAmp1 = "Enabled with positive and negative inputs" (Phase A)
// - OpAmp2 = "Enabled with positive and negative inputs" (Phase B)
// - OpAmp3 = "Enabled with positive and negative inputs" (Phase C)

// Hardware connections (per channel):
// - Shunt resistor: 0.01Ω per phase
// - Differential gain: 20 (configured by external resistors)
// - OA1_OUT → ADC_CH1
// - OA2_OUT → ADC_CH2
// - OA3_OUT → ADC_CH3

// Block configuration:
AMPCON1bits.AMPON = 1;      // Enable op-amp module
AMPCON1bits.AMPEN0 = 1;     // Enable OpAmp1 (Phase A)
AMPCON1bits.AMPEN1 = 1;     // Enable OpAmp2 (Phase B)
AMPCON1bits.AMPEN2 = 1;     // Enable OpAmp3 (Phase C)
AMPCON1bits.NCHDIS0 = 1;    // External network for all
AMPCON1bits.NCHDIS1 = 1;
AMPCON1bits.NCHDIS2 = 1;

// Synchronized three-phase current measurement
// Sample all three ADC channels simultaneously for accurate FOC
                </div>
            </div>
        </div>

        <div class="content-card">
            <h2>Design Considerations</h2>

            <h3>Gain Configuration</h3>
            <ul>
                <li><strong>Voltage Follower:</strong> No external components required, unity gain (1×), high input impedance</li>
                <li><strong>Non-Inverting:</strong> Gain = 1 + (R2/R1), input impedance ≈ op-amp input impedance (very high)</li>
                <li><strong>Inverting:</strong> Gain = -(R2/R1), input impedance = R1 (finite), inverted output phase</li>
                <li><strong>Differential:</strong> Gain = (R2/R1) for matched resistors, requires precision resistor matching</li>
            </ul>

            <h3>Bandwidth and Slew Rate</h3>
            <div class="warning">
                <strong>Frequency Limitations:</strong>
                <ul>
                    <li>Op-amp bandwidth typically ranges from 1 MHz to 10 MHz (device-dependent)</li>
                    <li>Gain-bandwidth product limits useful frequency range at higher gains</li>
                    <li>Slew rate limits large signal response (typically 1-10 V/μs)</li>
                    <li>Check device datasheet for specific performance parameters</li>
                </ul>
            </div>

            <h3>Offset and Calibration</h3>
            <ul>
                <li><strong>Input Offset Voltage:</strong> Typically ±1-5 mV (device-dependent)</li>
                <li><strong>Temperature Drift:</strong> Consider offset drift over operating temperature range</li>
                <li><strong>Calibration:</strong> Some devices support offset trim registers (check DOS module features)</li>
                <li><strong>Mitigation:</strong> Use AC coupling or software offset correction for critical applications</li>
            </ul>

            <h3>Power Supply Considerations</h3>
            <div class="info">
                <strong>Rail-to-Rail Operation:</strong>
                <ul>
                    <li>Input common-mode range typically extends from VSS to VDD - 1.5V</li>
                    <li>Output swing typically VSS + 100mV to VDD - 100mV under light loads</li>
                    <li>Ensure signal levels stay within op-amp linear range</li>
                    <li>Headroom required for proper operation, especially at high frequencies</li>
                </ul>
            </div>

            <h3>PCB Layout Guidelines</h3>
            <ul>
                <li><strong>Short Traces:</strong> Keep op-amp input and feedback traces as short as possible</li>
                <li><strong>Ground Plane:</strong> Use solid ground plane under op-amp circuitry</li>
                <li><strong>Decoupling:</strong> Place 100nF ceramic capacitor close to VDD pin</li>
                <li><strong>Separation:</strong> Separate analog and digital ground returns</li>
                <li><strong>Shielding:</strong> Shield sensitive inputs from switching noise sources</li>
            </ul>
        </div>

        <div class="content-card">
            <h2>Integration with Other Blocks</h2>

            <h3>Op-Amp + ADC Chain</h3>
            <div class="example">
                <strong>Optimized Signal Path:</strong>
                <ol>
                    <li>Configure MCHP_OP_AMP block for desired gain and mode</li>
                    <li>Connect op-amp output pin to dedicated ADC input channel</li>
                    <li>Configure MCHP_ADC block to sample from op-amp output pin</li>
                    <li>Synchronize ADC sampling with control loop timing</li>
                    <li>Apply digital calibration/offset correction if needed</li>
                </ol>
            </div>

            <h3>Op-Amp + PWM Synchronization</h3>
            <div class="info">
                <strong>Motor Control Application:</strong>
                <ul>
                    <li>Use op-amps to amplify shunt resistor voltages (current sensing)</li>
                    <li>Trigger ADC from PWM events to sample at optimal timing</li>
                    <li>Avoid sampling during PWM switching transitions</li>
                    <li>Use ADC trigger delay to account for op-amp settling time</li>
                </ul>
            </div>

            <h3>Multi-Instance Coordination</h3>
            <div class="code-block">
// Example: Three-phase motor current sensing
// OpAmp1 → ADC_CH1 (Phase A current)
// OpAmp2 → ADC_CH2 (Phase B current)
// OpAmp3 → ADC_CH3 (Phase C current)

// Configure all op-amps with identical gain
// Sample all ADC channels simultaneously
// Ensures phase alignment for FOC algorithm
            </div>
        </div>

        <div class="content-card">
            <h2>Troubleshooting</h2>

            <table class="parameter-table">
                <tr>
                    <th>Issue</th>
                    <th>Possible Causes</th>
                    <th>Solution</th>
                </tr>
                <tr>
                    <td>No output signal</td>
                    <td>
                        • AMPON not set<br>
                        • AMPENx not set<br>
                        • Pin not configured as analog
                    </td>
                    <td>
                        Verify block configuration enables the desired op-amp instance.
                        Check that MCHP_PORT is correctly configured (automatic in INITIALISATION).
                    </td>
                </tr>
                <tr>
                    <td>Saturated output</td>
                    <td>
                        • Excessive input signal<br>
                        • Incorrect gain setting<br>
                        • Insufficient supply headroom
                    </td>
                    <td>
                        Reduce input amplitude, check resistor values for correct gain,
                        ensure VDD provides adequate headroom for output swing.
                    </td>
                </tr>
                <tr>
                    <td>Oscillation</td>
                    <td>
                        • Poor PCB layout<br>
                        • Missing decoupling<br>
                        • Capacitive load
                    </td>
                    <td>
                        Add series resistor to output (10-50Ω), improve ground plane,
                        add decoupling capacitor close to VDD pin, reduce trace lengths.
                    </td>
                </tr>
                <tr>
                    <td>DC offset error</td>
                    <td>
                        • Input offset voltage<br>
                        • Bias current effects<br>
                        • Temperature drift
                    </td>
                    <td>
                        Apply software offset calibration, use AC coupling if DC accuracy
                        not required, check for trim registers in device datasheet.
                    </td>
                </tr>
                <tr>
                    <td>Incorrect gain</td>
                    <td>
                        • Wrong resistor values<br>
                        • Incorrect mode selection<br>
                        • Loading effects
                    </td>
                    <td>
                        Verify resistor network matches desired gain formula, ensure
                        NCHDIS bit matches mode (0 = internal, 1 = external), check
                        output load impedance is much higher than feedback resistors.
                    </td>
                </tr>
            </table>
        </div>

        <div class="content-card">
            <h2>Related Blocks</h2>
            <ul>
                <li><a href="MCHP_HighSpeed_AnalogComparator.html">MCHP_HighSpeed_AnalogComparator</a> - Fast analog comparator for threshold detection</li>
                <li><a href="pga.html">MCHP_PGA</a> - Programmable Gain Amplifier with digital gain control</li>
                <li><a href="../adc/adc_hs_sar_dspic33.html">MCHP_ADC_HS_SAR_dsPIC33</a> - High-speed ADC for digitizing op-amp outputs</li>
                <li><a href="../pwm/pwm_hs_fep.html">MCHP_PWM_HS_FEP</a> - PWM for motor control synchronization</li>
            </ul>
        </div>

        <a href="analog.html" class="back-link">← Back to Analog Blocks</a>
    </div>
    </div>
</body>
</html>
