<!DOCTYPE html>
<html>
<head>
    <title>MCHP High-Speed Analog Comparator - MCHP Blockset Documentation</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../assets/css/navigation.css">
    <script src="../../assets/js/navigation.js"></script>
</head>
<body>
    <!-- Mobile Navigation Toggle -->
    <button class="nav-toggle" aria-label="Toggle navigation">☰</button>

    <!-- Left Navigation Panel -->
    <nav class="doc-nav-container">
        <div class="doc-nav-header">
            <a href="../../index.html">MCHP Blockset Docs</a>
        </div>
        <ul class="doc-nav-menu">
            <li class="nav-item">
                <a href="../../index.html" class="nav-link">Home</a>
            </li>

            <!-- Getting Started Section -->
            <li class="nav-item">
                <div class="nav-category">Getting Started <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../getting_started/overview.html" class="nav-link">Overview</a></li>
                    <li><a href="../../getting_started/installation.html" class="nav-link">Installation</a></li>
                    <li><a href="../../getting_started/quick_start.html" class="nav-link">Quick Start</a></li>
                    <li><a href="../../getting_started/board_templates.html" class="nav-link">Board Templates</a></li>
                    <li><a href="../../getting_started/supported_devices.html" class="nav-link">Supported Devices</a></li>
                </ul>
            </li>

            <!-- User Guide Section -->
            <li class="nav-item">
                <div class="nav-category">User Guide <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../user_guide/index.html" class="nav-link">User Guide Overview</a></li>
                    <li><a href="../../user_guide/code_generation.html" class="nav-link">Code Generation</a></li>
                    <li><a href="../../user_guide/external_mode.html" class="nav-link">External Mode</a></li>
                </ul>
            </li>

            <!-- Block Reference Section -->
            <li class="nav-item">
                <div class="nav-category">Block Reference <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../block_reference/index.html" class="nav-link">Block Reference Overview</a></li>
                </ul>
            </li>

            <!-- Examples Section -->
            <li class="nav-item">
                <div class="nav-category">Examples <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../examples/field_weakening.html" class="nav-link">Field Weakening</a></li>
                </ul>
            </li>

            <!-- Release Notes -->
            <li class="nav-item">
                <a href="../../release_notes.html" class="nav-link">Release Notes</a>
            </li>
        </ul>
    </nav>

    <div class="doc-content-wrapper">
    <div class="header">
        <h1>MCHP High-Speed Analog Comparator</h1>
        <p>Fast threshold detection and PWM integration for motor control and power applications</p>
    </div>

    <div class="breadcrumb">
        <a href="../../index.html">Home</a>
        <span>›</span>
        <a href="../index.html">Block Reference</a>
        <span>›</span>
        <a href="analog.html">Analog Blocks</a>
        <span>›</span>
        <span>High-Speed Analog Comparator</span>
    </div>

    <div class="container">
        <div class="content-card">
            
    <!-- Block Icon -->
    <div class="block-image">
        <img src="../assets/images/blocks/analog/HighSpeed_AnalogComparator.svg"
             alt="HighSpeed_AnalogComparator Block Icon"
             onerror="this.onerror=null; this.src='../assets/images/blocks/analog/HighSpeed_AnalogComparator.png';">
        <div class="block-image-caption">
            HighSpeed_AnalogComparator Block Icon
        </div>
    </div>
<h2>Overview</h2>
            <p>The <strong>MCHP High-Speed Analog Comparator</strong> block configures the on-chip analog comparators for fast threshold detection applications. These comparators provide critical real-time monitoring for motor control overcurrent protection, power supply fault detection, and zero-crossing detection. With response times in the nanosecond range, they can directly trigger PWM fault events without CPU intervention.</p>

            <div class="note">
                <strong>Key Features:</strong>
                <ul>
                    <li>Sub-microsecond response time for critical fault protection</li>
                    <li>Multiple comparator instances (up to 4 per device)</li>
                    <li>Internal DAC reference or external voltage reference</li>
                    <li>Programmable hysteresis for noise immunity</li>
                    <li>Direct PWM fault input integration</li>
                    <li>Configurable output state monitoring</li>
                </ul>
            </div>

            <h3>Typical Applications</h3>
            <ul>
                <li><strong>Overcurrent Protection:</strong> Motor drive current limit detection</li>
                <li><strong>Overvoltage/Undervoltage:</strong> DC bus voltage monitoring</li>
                <li><strong>Zero-Crossing Detection:</strong> AC line synchronization</li>
                <li><strong>PWM Blanking:</strong> Noise immunity during switching</li>
                <li><strong>Peak Detection:</strong> Signal peak monitoring</li>
            </ul>
        </div>

        <div class="content-card">
            <h2>Device Family Support</h2>
            <div class="device-support">
                <div class="device-card">
                    <h4>dsPIC33EP</h4>
                    <p>1-4 Comparators</p>
                </div>
                <div class="device-card">
                    <h4>dsPIC33EV</h4>
                    <p>1-4 Comparators</p>
                </div>
                <div class="device-card">
                    <h4>dsPIC33CK</h4>
                    <p>1-4 Comparators</p>
                </div>
                <div class="device-card">
                    <h4>dsPIC33CH</h4>
                    <p>1-4 Comparators</p>
                </div>
            </div>

            <div class="info">
                <strong>Note:</strong> The number of available comparators varies by device. Check the MCHP Master block configuration to see which comparators are available for your selected chip.
            </div>
        </div>

        <div class="content-card">
            <h2>Block Parameters</h2>

            <h3>Comparator Enable Configuration</h3>
            <table class="parameter-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Description</th>
                        <th>Options</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Comparator 1/2/3/4 Enable</strong></td>
                        <td>Enable or disable each comparator instance</td>
                        <td>on, off</td>
                    </tr>
                    <tr>
                        <td><strong>Comparator Pin</strong></td>
                        <td>Select input pin for positive comparator input</td>
                        <td>Device-specific pin list</td>
                    </tr>
                    <tr>
                        <td><strong>External Reference Pin</strong></td>
                        <td>Select pin for external voltage reference (negative input)</td>
                        <td>Device-specific pin list or Internal DAC</td>
                    </tr>
                </tbody>
            </table>

            <h3>Reference Voltage Configuration</h3>
            <table class="parameter-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Description</th>
                        <th>Range</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>CMREF (DAC Reference)</strong></td>
                        <td>Internal DAC voltage reference setting</td>
                        <td>0 to 4095 (12-bit)</td>
                    </tr>
                    <tr>
                        <td><strong>External Reference Range</strong></td>
                        <td>Voltage range for external reference input</td>
                        <td>Device-specific ranges</td>
                    </tr>
                    <tr>
                        <td><strong>External Reference Voltage</strong></td>
                        <td>Actual voltage when using external reference</td>
                        <td>User-defined (for simulation)</td>
                    </tr>
                </tbody>
            </table>

            <h3>Comparator Operating Mode</h3>
            <table class="parameter-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Description</th>
                        <th>Options</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>HYSSEL (Hysteresis Select)</strong></td>
                        <td>Hysteresis voltage level for noise immunity</td>
                        <td>None, 5mV, 10mV, 15mV (device-dependent)</td>
                    </tr>
                    <tr>
                        <td><strong>HYSPOL (Hysteresis Polarity)</strong></td>
                        <td>Direction of hysteresis application</td>
                        <td>Rising edge, Falling edge</td>
                    </tr>
                    <tr>
                        <td><strong>COMP (Comparator Mode)</strong></td>
                        <td>Operating mode and speed selection</td>
                        <td>Normal, High-speed</td>
                    </tr>
                    <tr>
                        <td><strong>FLTREN (Filter Enable)</strong></td>
                        <td>Enable digital filtering on output</td>
                        <td>Enabled, Disabled</td>
                    </tr>
                    <tr>
                        <td><strong>DACOE (DAC Output Enable)</strong></td>
                        <td>Enable DAC output to pin</td>
                        <td>Enabled, Disabled</td>
                    </tr>
                    <tr>
                        <td><strong>State Output</strong></td>
                        <td>Enable comparator state output port</td>
                        <td>Enabled, Disabled</td>
                    </tr>
                </tbody>
            </table>

            <div class="warning">
                <strong>Important:</strong> When using comparators for PWM fault detection, ensure the comparator response time is faster than your PWM switching frequency. Typical response times range from 100ns to 500ns depending on operating mode.
            </div>
        </div>

        <div class="content-card">
            <h2>Register Configuration</h2>

            <h3>Key Registers</h3>
            <table class="parameter-table">
                <thead>
                    <tr>
                        <th>Register</th>
                        <th>Description</th>
                        <th>Configured By</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>CMxCON</strong></td>
                        <td>Comparator x control register</td>
                        <td>Operating mode, polarity, enable</td>
                    </tr>
                    <tr>
                        <td><strong>CMxMSKCON</strong></td>
                        <td>Comparator x mask control</td>
                        <td>PWM blanking configuration</td>
                    </tr>
                    <tr>
                        <td><strong>CMxFLTR</strong></td>
                        <td>Comparator x filter register</td>
                        <td>Digital filter settings</td>
                    </tr>
                    <tr>
                        <td><strong>CVRCON</strong></td>
                        <td>Comparator voltage reference control</td>
                        <td>Internal DAC configuration</td>
                    </tr>
                    <tr>
                        <td><strong>CMxDAC</strong></td>
                        <td>Comparator x DAC data register</td>
                        <td>DAC reference voltage value</td>
                    </tr>
                </tbody>
            </table>

            <h3>CMxCON Register Bits (Example)</h3>
            <div class="code-block">
CMxCON = 0x8000;  // Comparator enabled
         | (CPOL << 13)   // Output polarity
         | (COE << 14)    // Output enable
         | (CREF << 12)   // Reference select
         | (CCH << 0);    // Channel select
            </div>
        </div>

        <div class="content-card">
            <h2>Practical Examples</h2>

            <h3>Example 1: Motor Overcurrent Protection</h3>
            <div class="example">
                <h4>Objective:</h4>
                <p>Implement fast overcurrent detection for a 3-phase motor drive using 3.3V/A current sensing with 2.5A trip threshold.</p>

                <h4>Configuration:</h4>
                <ul>
                    <li><strong>Comparator 1 Enable:</strong> on</li>
                    <li><strong>Comparator 1 Pin:</strong> AN0 (current sense input)</li>
                    <li><strong>External Reference Pin:</strong> Internal DAC</li>
                    <li><strong>CMREF (DAC Value):</strong> 2730 (for 2.5A × 3.3V/A = 8.25V → ~2730 @ 12-bit)</li>
                    <li><strong>HYSSEL:</strong> 10mV (noise immunity)</li>
                    <li><strong>HYSPOL:</strong> Rising edge</li>
                    <li><strong>COMP Mode:</strong> High-speed</li>
                    <li><strong>State Output:</strong> Enabled → Connect to PWM Fault Input</li>
                </ul>

                <h4>Implementation Notes:</h4>
                <div class="code-block">
// In Simulink model:
// 1. Add MCHP_HighSpeed_AnalogComparator block
// 2. Connect State Output to PWM_HS block Fault Input
// 3. Configure PWM Fault mode: Cycle-by-cycle current limit
// 4. Result: Automatic PWM shutdown within 200ns of overcurrent

DAC_Voltage = (CMREF / 4095) * Vref;  // Calculate threshold
// For 8.25V with 3.3V Vref: CMREF = 2730
                </div>
            </div>

            <h3>Example 2: DC Bus Overvoltage Detection</h3>
            <div class="example">
                <h4>Objective:</h4>
                <p>Monitor DC bus voltage with 400V trip threshold using external voltage divider (100:1 ratio).</p>

                <h4>Configuration:</h4>
                <ul>
                    <li><strong>Comparator 2 Enable:</strong> on</li>
                    <li><strong>Comparator 2 Pin:</strong> AN1 (DC bus sense, scaled to 0-4V)</li>
                    <li><strong>External Reference Pin:</strong> Internal DAC</li>
                    <li><strong>CMREF (DAC Value):</strong> 4095 (max for 400V/100 = 4.0V)</li>
                    <li><strong>HYSSEL:</strong> 15mV (prevent chattering)</li>
                    <li><strong>HYSPOL:</strong> Rising edge</li>
                    <li><strong>FLTREN:</strong> Enabled (50ns digital filter)</li>
                    <li><strong>State Output:</strong> Enabled → Feed to fault handler</li>
                </ul>

                <h4>Hardware Setup:</h4>
                <div class="code-block">
// Voltage divider calculation:
// DC Bus: 0-450V → Comparator input: 0-4.5V (via 100:1 divider)
// Trip at 400V → 4.0V at comparator input
// CMREF = (4.0V / 3.3V) * 4095 = 4095 (saturated, use 3.3V trip)

// Adjust divider for better resolution:
// Use 120:1 divider → 400V = 3.33V
// CMREF = (3.33 / 3.3) * 4095 = ~4120 → Use 4095
                </div>
            </div>

            <h3>Example 3: Zero-Crossing Detection for PFC</h3>
            <div class="example">
                <h4>Objective:</h4>
                <p>Detect AC line zero-crossing for Power Factor Correction (PFC) synchronization at 50Hz/60Hz.</p>

                <h4>Configuration:</h4>
                <ul>
                    <li><strong>Comparator 3 Enable:</strong> on</li>
                    <li><strong>Comparator 3 Pin:</strong> AN2 (AC line sense, isolated and scaled)</li>
                    <li><strong>External Reference Pin:</strong> Internal DAC</li>
                    <li><strong>CMREF (DAC Value):</strong> 2048 (mid-scale for zero-crossing)</li>
                    <li><strong>HYSSEL:</strong> 5mV (tight threshold)</li>
                    <li><strong>HYSPOL:</strong> Both edges (detect rising and falling)</li>
                    <li><strong>COMP Mode:</strong> High-speed</li>
                    <li><strong>State Output:</strong> Enabled → Trigger interrupt for sync</li>
                </ul>

                <h4>Signal Processing:</h4>
                <div class="code-block">
// AC line conditioning:
// 1. Isolation transformer (230V → 12V AC)
// 2. Rectifier + offset (0 to 3.3V DC, centered at 1.65V)
// 3. Zero-crossing at 1.65V → CMREF = 2048

// In firmware (triggered by comparator interrupt):
void ZeroCrossingISR(void) {
    static uint32_t last_crossing = 0;
    uint32_t current_time = TMR1;
    uint32_t period = current_time - last_crossing;

    // Update PFC phase reference
    PFC_PhaseAngle = 0;
    last_crossing = current_time;
}
                </div>
            </div>

            <h3>Example 4: Peak Detection with Hysteresis</h3>
            <div class="example">
                <h4>Objective:</h4>
                <p>Detect signal peaks for envelope detection in communication or audio applications.</p>

                <h4>Configuration:</h4>
                <ul>
                    <li><strong>Comparator 4 Enable:</strong> on</li>
                    <li><strong>Comparator 4 Pin:</strong> AN3 (signal input)</li>
                    <li><strong>External Reference Pin:</strong> AN4 (tracking reference from RC circuit)</li>
                    <li><strong>HYSSEL:</strong> 20mV (prevent multiple triggers)</li>
                    <li><strong>HYSPOL:</strong> Rising edge</li>
                    <li><strong>FLTREN:</strong> Disabled (preserve fast edges)</li>
                    <li><strong>State Output:</strong> Enabled → Feed to capture module</li>
                </ul>

                <h4>Application Circuit:</h4>
                <div class="code-block">
// Peak detector hardware:
// 1. Input signal → AN3 (Comparator positive input)
// 2. RC peak detector → AN4 (Comparator negative input)
// 3. Output triggers on signal peak exceeding RC voltage

// Hysteresis prevents multiple triggers:
//   - Rising edge: Trigger when Input > (Reference + 20mV)
//   - Reset when Input < (Reference - 20mV)

// Time constant: τ = R × C
// For audio (20Hz-20kHz): τ = 10ms → R=10kΩ, C=1µF
                </div>
            </div>
        </div>

        <div class="content-card">
            <h2>Integration with PWM Blocks</h2>

            <h3>PWM Fault Input Connection</h3>
            <p>The comparator output can directly trigger PWM fault events for immediate protection without CPU intervention.</p>

            <div class="code-block">
Simulink Connection:
1. MCHP_HighSpeed_AnalogComparator [State Output] →
2. MCHP_PWM_HS [Fault Input Port]

PWM Fault Configuration:
- Fault Mode: Cycle-by-cycle current limit
- Fault Action: Force outputs LOW
- Fault Clear: Automatic after fault condition removed
- Response Time: < 500ns (hardware-based)
            </div>

            <h3>Blanking Window Integration</h3>
            <p>Configure PWM blanking to prevent false triggers during switching transients:</p>
            <div class="code-block">
CMxMSKCON Configuration:
- MASKSEL: Select PWM generator for blanking
- BLNKMD: Blanking mode (leading edge, trailing edge, both)
- BLNKDUR: Blanking duration (0-4095 cycles)

// Example: 2µs blanking at 100MHz PWM
BLNKDUR = 200;  // 2µs × 100MHz = 200 cycles
            </div>
        </div>

        <div class="content-card">
            <h2>Troubleshooting</h2>

            <h3>Common Issues and Solutions</h3>
            <table class="parameter-table">
                <thead>
                    <tr>
                        <th>Issue</th>
                        <th>Possible Cause</th>
                        <th>Solution</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Comparator always triggered</td>
                        <td>Reference voltage too low or input offset</td>
                        <td>Verify DAC voltage calculation and input signal range</td>
                    </tr>
                    <tr>
                        <td>Intermittent false triggers</td>
                        <td>Insufficient hysteresis or noise coupling</td>
                        <td>Increase HYSSEL value and improve PCB layout</td>
                    </tr>
                    <tr>
                        <td>Slow response time</td>
                        <td>Normal mode selected or filtering enabled</td>
                        <td>Switch to High-speed mode and disable FLTREN</td>
                    </tr>
                    <tr>
                        <td>PWM blanking not working</td>
                        <td>Incorrect blanking window configuration</td>
                        <td>Verify MASKSEL and BLNKDUR settings</td>
                    </tr>
                    <tr>
                        <td>State output not updating</td>
                        <td>State Output parameter disabled</td>
                        <td>Enable State Output in block parameters</td>
                    </tr>
                    <tr>
                        <td>Pin assignment errors</td>
                        <td>Selected pin not available on device</td>
                        <td>Check MCHP Master block for valid pin options</td>
                    </tr>
                </tbody>
            </table>

            <h3>Debugging Tips</h3>
            <div class="info">
                <strong>Testing Comparator Operation:</strong>
                <ol>
                    <li><strong>Verify Reference Voltage:</strong> If DACOE enabled, measure DAC output voltage</li>
                    <li><strong>Monitor State Output:</strong> Add LED or scope probe to state output pin</li>
                    <li><strong>Test Hysteresis:</strong> Slowly vary input voltage and verify switching thresholds</li>
                    <li><strong>Check Response Time:</strong> Use oscilloscope to measure input-to-output delay</li>
                    <li><strong>Validate PWM Integration:</strong> Trigger fault and verify PWM shutdown timing</li>
                </ol>
            </div>
        </div>

        <div class="content-card">
            <h2>Performance Characteristics</h2>

            <h3>Timing Specifications</h3>
            <table class="parameter-table">
                <thead>
                    <tr>
                        <th>Parameter</th>
                        <th>Normal Mode</th>
                        <th>High-Speed Mode</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Response Time</td>
                        <td>500ns typical</td>
                        <td>100-200ns typical</td>
                    </tr>
                    <tr>
                        <td>Propagation Delay</td>
                        <td>300-600ns</td>
                        <td>80-150ns</td>
                    </tr>
                    <tr>
                        <td>Current Consumption</td>
                        <td>10µA typical</td>
                        <td>50µA typical</td>
                    </tr>
                    <tr>
                        <td>Input Offset Voltage</td>
                        <td>±5mV typical</td>
                        <td>±10mV typical</td>
                    </tr>
                </tbody>
            </table>

            <div class="warning">
                <strong>Power vs. Speed Tradeoff:</strong> High-speed mode provides faster response but consumes 5× more current. Use normal mode for non-critical monitoring to conserve power.
            </div>
        </div>

        <div class="content-card">
            <h2>Related Blocks</h2>
            <ul>
                <li><a href="MCHP_HighSpeed_AnalogComparator_wSlope.html">MCHP High-Speed Analog Comparator with Slope Compensation</a> - Extended version with slope compensation for peak current mode control</li>
                <li><a href="../pwm/MCHP_PWM_HS.html">MCHP PWM High-Speed</a> - PWM block with fault input integration</li>
                <li><a href="../adc/MCHP_ADC_HS.html">MCHP ADC High-Speed</a> - Fast ADC for complementary measurements</li>
                <li><a href="MCHP_OP_AMP.html">MCHP Operational Amplifier</a> - Signal conditioning for comparator inputs</li>
            </ul>
        </div>

        <div class="content-card">
            <h2>References</h2>
            <ul>
                <li><strong>Device Datasheet:</strong> Comparator module electrical specifications</li>
                <li><strong>Family Reference Manual:</strong> Comparator module detailed operation</li>
                <li><strong>Application Notes:</strong>
                    <ul>
                        <li><a href="https://www.microchip.com/AN1106">AN1106</a> - Comparator-Based PWM Fault Protection</li>
                        <li><a href="https://www.microchip.com/AN2743">AN2743</a> - Peak Current Mode Control with Slope Compensation</li>
                    </ul>
                </li>
                <li><strong>Code Examples:</strong> Check MCHP Blockset examples folder for motor control applications</li>
            </ul>
        </div>
    </div>
    </div>
</body>
</html>
