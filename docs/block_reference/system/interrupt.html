<!DOCTYPE html>
<html>
<head>
    <title>MCHP_Interrupt - MCHP Blockset</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../assets/css/navigation.css">
    <script src="../../assets/js/navigation.js"></script>
</head>
<body>
    <!-- Mobile Navigation Toggle -->
    <button class="nav-toggle" aria-label="Toggle navigation">☰</button>

    <!-- Left Navigation Panel -->
    <nav class="doc-nav-container">
        <div class="doc-nav-header">
            <a href="../../index.html">MCHP Blockset Docs</a>
        </div>
        <ul class="doc-nav-menu">
            <li class="nav-item">
                <a href="../../index.html" class="nav-link">Home</a>
            </li>

            <!-- Getting Started Section -->
            <li class="nav-item">
                <div class="nav-category">Getting Started <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../getting_started/overview.html" class="nav-link">Overview</a></li>
                    <li><a href="../../getting_started/installation.html" class="nav-link">Installation</a></li>
                    <li><a href="../../getting_started/quick_start.html" class="nav-link">Quick Start</a></li>
                    <li><a href="../../getting_started/board_templates.html" class="nav-link">Board Templates</a></li>
                    <li><a href="../../getting_started/supported_devices.html" class="nav-link">Supported Devices</a></li>
                </ul>
            </li>

            <!-- User Guide Section -->
            <li class="nav-item">
                <div class="nav-category">User Guide <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../user_guide/index.html" class="nav-link">User Guide Overview</a></li>
                    <li><a href="../../user_guide/code_generation.html" class="nav-link">Code Generation</a></li>
                    <li><a href="../../user_guide/external_mode.html" class="nav-link">External Mode</a></li>
                </ul>
            </li>

            <!-- Block Reference Section -->
            <li class="nav-item">
                <div class="nav-category">Block Reference <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../block_reference/index.html" class="nav-link">Block Reference Overview</a></li>
                </ul>
            </li>

            <!-- Examples Section -->
            <li class="nav-item">
                <div class="nav-category">Examples <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../examples/field_weakening.html" class="nav-link">Field Weakening</a></li>
                </ul>
            </li>

            <!-- Release Notes -->
            <li class="nav-item">
                <a href="../../release_notes.html" class="nav-link">Release Notes</a>
            </li>
        </ul>
    </nav>

    <div class="doc-content-wrapper">
    <div class="breadcrumb">
        <a href="../index.html">Block Reference</a> &gt;
        <a href="./system.html">System Blocks</a> &gt;
        MCHP_Interrupt
    </div>

    <h1>MCHP_Interrupt - Interrupt Service Routine Configuration</h1>

    
    <!-- Block Icon -->
    <div class="block-image">
        <img src="../assets/images/blocks/system_functions/Interrupt.svg"
             alt="Interrupt Block Icon"
             onerror="this.onerror=null; this.src='../assets/images/blocks/system_functions/Interrupt.png';">
        <div class="block-image-caption">
            Interrupt Block Icon
        </div>
    </div>
<h2>Description</h2>
    <p>The <strong>MCHP_Interrupt</strong> block creates interrupt-driven subsystems by connecting peripheral interrupt sources to Simulink triggered subsystems. The block automatically manages interrupt vector configuration, priority levels, and timing synchronization.</p>

    <p><strong>Key Capabilities:</strong></p>
    <ul>
        <li><strong>Automatic interrupt detection</strong> - Discovers all peripheral interrupts in model</li>
        <li><strong>Dynamic interrupt list</strong> - Popup shows only available interrupts from active peripherals</li>
        <li><strong>Priority management</strong> - Configure interrupt priority levels (device-dependent)</li>
        <li><strong>Multiple timing modes</strong> - Base rate, periodic trigger, or hardware timer-based</li>
        <li><strong>Context preservation</strong> - Automatic FPU context save/restore (PIC32 with FPU)</li>
    </ul>

    <h2>Interrupt Sources</h2>

    <h3>Peripheral Interrupts (Auto-detected)</h3>
    <p>The block automatically detects interrupts from peripheral blocks in your model:</p>
    <table>
        <thead>
            <tr>
                <th>Peripheral</th>
                <th>Interrupt Types</th>
                <th>Example Usage</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>ADC</strong></td>
                <td>• Conversion complete<br>• Individual converter done<br>• FIFO threshold</td>
                <td>Fast current sampling for motor control</td>
            </tr>
            <tr>
                <td><strong>PWM</strong></td>
                <td>• Period match<br>• Trigger event<br>• Fault detection</td>
                <td>Synchronize control loop to PWM period</td>
            </tr>
            <tr>
                <td><strong>QEI</strong></td>
                <td>• Position counter overflow<br>• Index pulse<br>• Home switch</td>
                <td>Encoder event handling</td>
            </tr>
            <tr>
                <td><strong>UART</strong></td>
                <td>• RX data ready<br>• TX buffer empty<br>• Error condition</td>
                <td>Asynchronous communication</td>
            </tr>
            <tr>
                <td><strong>SPI</strong></td>
                <td>• Transfer complete<br>• Buffer full/empty<br>• Fault</td>
                <td>High-speed data transfer</td>
            </tr>
            <tr>
                <td><strong>I2C</strong></td>
                <td>• Master/slave events<br>• Address match<br>• NACK received</td>
                <td>Sensor communication</td>
            </tr>
            <tr>
                <td><strong>CAN</strong></td>
                <td>• Message received<br>• TX complete<br>• Bus error</td>
                <td>Automotive communication</td>
            </tr>
            <tr>
                <td><strong>Timer</strong></td>
                <td>• Period match<br>• Compare match</td>
                <td>Custom timing events</td>
            </tr>
        </tbody>
    </table>

    <h3>User-Defined Interrupts</h3>
    <p>Peripheral blocks can define custom interrupts using <code>MCHP_USER_INTERRUPTS</code> parameter:</p>
    <pre><code>// In peripheral block RTWdata
MCHP_USER_INTERRUPTS = '{IFSx_bit}{Short_Desc}{Long_Desc}{Parameters};'

Parameters format:
  VectorName(name)           % If new vector needed
  Config_BitSet(IECx=value)  % Interrupt enable bits
  RegisterReadClear(IFSx)    % Flag clear register
  Priority(level)            % Fixed priority or -1 for user config
</code></pre>

    <h2>Block Parameters</h2>

    <h3>Interrupt Selection</h3>
    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Description</th>
                <th>Values</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Interruption</strong></td>
                <td>Select interrupt source from dynamic list of available peripheral interrupts.</td>
                <td>• Not defined<br>• ADC1<br>• PWM1 Period<br>• QEI1 Position<br>• UART1 RX<br>• SPI1 RX<br>• (device/model-dependent)</td>
            </tr>
            <tr>
                <td><strong>IntPriority</strong></td>
                <td>Interrupt priority level (if configurable). Higher number = higher priority.</td>
                <td>1-7 (dsPIC/PIC24)<br>1-7 (PIC32)<br>0-15 (ARM - 0=highest)</td>
            </tr>
            <tr>
                <td><strong>FPUNoSave</strong><br>(PIC32 with FPU only)</td>
                <td>Disable automatic FPU context save if ISR does not use floating-point operations (optimization).</td>
                <td>on / off</td>
            </tr>
            <tr>
                <td><strong>StartupExecute</strong></td>
                <td>Execute subsystem once during initialization (before first interrupt).</td>
                <td>on / off</td>
            </tr>
        </tbody>
    </table>

    <h3>Timing Configuration</h3>
    <table>
        <thead>
            <tr>
                <th>Parameter</th>
                <th>Description</th>
                <th>Use Case</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Triggered_Sub_TimeSource</strong></td>
                <td>Timing reference for triggered subsystem sample time.</td>
                <td>• <strong>Base rate:</strong> Synchronized to model base rate<br>• <strong>Periodic trigs:</strong> User-specified period<br>• <strong>Hardware timer:</strong> Dedicated timer resource</td>
            </tr>
            <tr>
                <td><strong>TrigsPeriod</strong><br>(Periodic trigs mode)</td>
                <td>Subsystem sample time when using periodic trigger mode.</td>
                <td>Any value matching trigger rate (e.g., 100e-6 for 10 kHz)</td>
            </tr>
            <tr>
                <td><strong>TIMER_Resolution</strong><br>(Hardware timer mode)</td>
                <td>Select timer prescaler for desired resolution and max period.</td>
                <td>Dynamic list based on device:<br>• dsPIC: 1, 8, 64, 256 prescalers<br>• PIC32: 1, 2, 4, 8, 16, 32, 64, 256<br>• SAM: 8, 32, 128 divisors</td>
            </tr>
        </tbody>
    </table>

    <h2>Device-Specific Interrupt Configuration</h2>

    <h3>dsPIC30F/33F/33E/33C/33A</h3>
    <table>
        <thead>
            <tr>
                <th>Feature</th>
                <th>Configuration</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Priority Levels</strong></td>
                <td>1-7 (7 = highest)</td>
                <td>Default is level 4</td>
            </tr>
            <tr>
                <td><strong>Nesting</strong></td>
                <td>Automatic if priorities differ</td>
                <td>Higher priority can preempt lower</td>
            </tr>
            <tr>
                <td><strong>Vector Table</strong></td>
                <td>Auto-managed by blockset</td>
                <td>IVT and AIVT support</td>
            </tr>
            <tr>
                <td><strong>Context Save</strong></td>
                <td>W0-W15, RCOUNT, SR</td>
                <td>Automatic register preservation</td>
            </tr>
        </tbody>
    </table>

    <h3>PIC32 (MIPS)</h3>
    <table>
        <thead>
            <tr>
                <th>Feature</th>
                <th>Configuration</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Priority Levels</strong></td>
                <td>1-7 (7 = highest)</td>
                <td>Sub-priority 0-3 also available</td>
            </tr>
            <tr>
                <td><strong>Shadow Registers</strong></td>
                <td>Automatic if configured</td>
                <td>Fast context switch (no save)</td>
            </tr>
            <tr>
                <td><strong>FPU Context</strong></td>
                <td>Optional save/restore</td>
                <td>Only if FP ops used in ISR</td>
            </tr>
            <tr>
                <td><strong>Multi-Vector Mode</strong></td>
                <td>Enabled by blockset</td>
                <td>Each peripheral has dedicated vector</td>
            </tr>
        </tbody>
    </table>

    <h3>SAM (ARM Cortex-M)</h3>
    <table>
        <thead>
            <tr>
                <th>Feature</th>
                <th>Configuration</th>
                <th>Notes</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><strong>Priority Levels</strong></td>
                <td>0-15 (0 = highest)</td>
                <td>NVIC priority grouping</td>
            </tr>
            <tr>
                <td><strong>Tail-Chaining</strong></td>
                <td>Automatic hardware optimization</td>
                <td>Back-to-back ISRs without full context restore</td>
            </tr>
            <tr>
                <td><strong>Late Arrival</strong></td>
                <td>Hardware-managed preemption</td>
                <td>Higher priority can preempt during stacking</td>
            </tr>
            <tr>
                <td><strong>FPU Lazy Stacking</strong></td>
                <td>Conditional FP context save</td>
                <td>Only saved if FP registers used</td>
            </tr>
        </tbody>
    </table>

    <h2>Examples</h2>

    <h3>Example 1: ADC Interrupt-Driven Current Loop</h3>
    <pre><code>// PWM triggers ADC, ADC interrupt executes control loop

Simulink Model:
1. Add PWM_HS block with ADC trigger output
2. Add ADC block with interrupt enabled
3. Add MCHP_Interrupt block
4. Configure interrupt block:
   Interruption: 'ADC1 - Conversion Complete'
   Triggered_Sub_TimeSource: 'is derived from model base rate'
   IntPriority: 7  (highest - critical for motor control)

5. Create triggered subsystem connected to interrupt block
6. Add current control algorithm inside subsystem

Result: Current loop executes synchronously with PWM/ADC
</code></pre>

    <h3>Example 2: UART Receive Interrupt</h3>
    <pre><code>// Process received data asynchronously

Configuration:
   Interruption: 'UART1 - RX'
   Triggered_Sub_TimeSource: 'is derived from trigs; trigs must be periodic'
   TrigsPeriod: 1e-3  % 1 ms assumed for timing (actual rate is async)
   IntPriority: 3  (medium priority)
   StartupExecute: on  (initialize buffers)

Subsystem:
- Read UART data from peripheral block
- Parse protocol
- Update command registers
</code></pre>

    <h3>Example 3: Hardware Timer Periodic Interrupt</h3>
    <pre><code>// Custom periodic task independent of base rate

Configuration:
   Interruption: 'User Timer1'  (created by peripheral block)
   Triggered_Sub_TimeSource: 'is derived from a hardware timer'
   TIMER_Resolution: 'Resol: 32us - MaxPer: 2.1s'  (prescaler 256)
   IntPriority: 5

Result:
- Dedicated timer allocated automatically
- Interrupt triggers at specified rate
- Independent of Simulink sample times
</code></pre>

    <h3>Example 4: QEI Position Overflow Event</h3>
    <pre><code>// Extend encoder range with software counter

Configuration:
   Interruption: 'QEI1 - Position Counter Overflow'
   Triggered_Sub_TimeSource: 'is derived from model base rate'
   IntPriority: 6  (high - timing critical)

Subsystem Logic:
if (QEI_DIR == FORWARD)
    ExtendedPosition += 65536;
else
    ExtendedPosition -= 65536;
end
</code></pre>

    <h2>Timing Modes Explained</h2>

    <h3>Mode 1: Derived from Model Base Rate</h3>
    <ul>
        <li>Subsystem sample time = model base rate</li>
        <li>Timing analysis uses base rate for schedulability</li>
        <li>Best for interrupts synchronized with main control loop</li>
        <li>Example: ADC conversion complete after PWM trigger</li>
    </ul>

    <h3>Mode 2: Derived from Periodic Trigs</h3>
    <ul>
        <li>User specifies expected interrupt rate in TrigsPeriod</li>
        <li>Allows timing analysis for asynchronous interrupts</li>
        <li>Subsystem scheduled assuming periodic behavior</li>
        <li>Example: UART receive (assume max message rate)</li>
    </ul>

    <h3>Mode 3: Hardware Timer-Based</h3>
    <ul>
        <li>Dedicated timer resource automatically allocated</li>
        <li>Timer configured with selected prescaler</li>
        <li>True periodic interrupt independent of Simulink rates</li>
        <li>Example: Custom 1 kHz update loop</li>
    </ul>

    <h2>Troubleshooting</h2>

    <table>
        <thead>
            <tr>
                <th>Problem</th>
                <th>Cause</th>
                <th>Solution</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>Interrupt not listed</td>
                <td>Peripheral block not in model or interrupt not enabled</td>
                <td>Add peripheral block, enable interrupt in peripheral config</td>
            </tr>
            <tr>
                <td>Subsystem never executes</td>
                <td>Interrupt source not configured correctly</td>
                <td>Verify peripheral interrupt enable, check flag register</td>
            </tr>
            <tr>
                <td>System hangs in ISR</td>
                <td>Interrupt flag not cleared</td>
                <td>Ensure RegisterReadClear is correct in peripheral definition</td>
            </tr>
            <tr>
                <td>Priority not working</td>
                <td>Architecture limitation or incorrect setting</td>
                <td>Check device datasheet for valid priority range</td>
            </tr>
            <tr>
                <td>FPU corruption (PIC32)</td>
                <td>FPUNoSave enabled but FP ops in ISR</td>
                <td>Disable FPUNoSave or remove FP operations from ISR</td>
            </tr>
        </tbody>
    </table>

    <div class="warning">
        <strong>Important Considerations:</strong>
        <ul>
            <li>Keep ISR execution time short - long ISRs can cause overload</li>
            <li>Higher priority ISRs can preempt lower priority - ensure reentrancy</li>
            <li>Hardware timer mode consumes one timer resource</li>
            <li>StartupExecute useful for initializing communication protocols</li>
        </ul>
    </div>

    <h2>See Also</h2>
    <ul>
        <li><a href="scheduler_options.html">MCHP_Scheduler_Options</a> - Multitasking scheduler configuration</li>
        <li><a href="master.html">MCHP_Master</a> - Clock and device configuration</li>
        <li><a href="../adc/adc_universal.html">MCHP_ADC_Universal</a> - ADC interrupt sources</li>
        <li><a href="../pwm/pwm_hs_fep.html">MCHP_PWM_HS_FEP</a> - PWM event interrupts</li>
    </ul>

    <footer>
        <p>&copy; 2025 Microchip Technology Inc. MCHP Blockset Documentation.</p>
    </footer>
    </div>
</body>
</html>
