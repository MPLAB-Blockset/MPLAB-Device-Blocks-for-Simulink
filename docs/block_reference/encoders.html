<!DOCTYPE html>
<html>
<head>
    <title>Encoder & Counter Blocks - MCHP Blockset</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../assets/css/navigation.css">
    <script src="../assets/js/navigation.js"></script>
</head>
<body>
    <!-- Mobile Navigation Toggle -->
    <button class="nav-toggle" aria-label="Toggle navigation">☰</button>

    <!-- Left Navigation Panel -->
    <nav class="doc-nav-container">
        <div class="doc-nav-header">
            <a href="../index.html">MCHP Blockset Docs</a>
        </div>
        <ul class="doc-nav-menu">
            <li class="nav-item">
                <a href="../index.html" class="nav-link">Home</a>
            </li>

            <!-- Getting Started Section -->
            <li class="nav-item">
                <div class="nav-category">Getting Started <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../getting_started/overview.html" class="nav-link">Overview</a></li>
                    <li><a href="../getting_started/installation.html" class="nav-link">Installation</a></li>
                    <li><a href="../getting_started/quick_start.html" class="nav-link">Quick Start</a></li>
                    <li><a href="../getting_started/board_templates.html" class="nav-link">Board Templates</a></li>
                    <li><a href="../getting_started/supported_devices.html" class="nav-link">Supported Devices</a></li>
                </ul>
            </li>

            <!-- User Guide Section -->
            <li class="nav-item">
                <div class="nav-category">User Guide <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../user_guide/index.html" class="nav-link">User Guide Overview</a></li>
                    <li><a href="../user_guide/code_generation.html" class="nav-link">Code Generation</a></li>
                    <li><a href="../user_guide/external_mode.html" class="nav-link">External Mode</a></li>
                </ul>
            </li>

            <!-- Block Reference Section -->
            <li class="nav-item">
                <div class="nav-category">Block Reference <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../block_reference/index.html" class="nav-link">Block Reference Overview</a></li>
                </ul>
            </li>

            <!-- Examples Section -->
            <li class="nav-item">
                <div class="nav-category">Examples <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../examples/field_weakening.html" class="nav-link">Field Weakening</a></li>
                </ul>
            </li>

            <!-- Release Notes -->
            <li class="nav-item">
                <a href="../release_notes.html" class="nav-link">Release Notes</a>
            </li>
        </ul>
    </nav>

    <div class="doc-content-wrapper">
    <div class="breadcrumb">
        <a href="index.html">MCHP Blockset</a> &gt;
        <strong>Encoder & Counter Blocks</strong>
    </div>

    <div class="header">
        <h1>Encoder & Counter Blocks</h1>
        <p>Position, Velocity, and Edge Detection for Motion Control</p>
    </div>

    <div class="content-section">
        <h2>Overview</h2>
        <p>The MCHP Blockset provides comprehensive encoder and counter blocks for position sensing, velocity measurement, and event detection in motor control and mechatronics applications. These blocks interface with hardware peripherals optimized for quadrature encoders, Hall sensors, and general-purpose pulse counting.</p>

        <div class="note-box">
            <strong>Applications:</strong>
            <ul>
                <li><strong>Motor Control:</strong> Position and speed feedback for servo drives, BLDC motors, and stepper systems</li>
                <li><strong>Positioning Systems:</strong> Linear and rotary position measurement for robotics and automation</li>
                <li><strong>Velocity Measurement:</strong> Tachometer replacement using encoder signals</li>
                <li><strong>Event Counting:</strong> Pulse counting, frequency measurement, and event detection</li>
                <li><strong>User Interface:</strong> Rotary encoders for knobs, switches, and control panels</li>
            </ul>
        </div>
    </div>

    <div class="content-section">
        <h2>Available Blocks</h2>

        <div class="block-grid">
            <div class="block-card">
                <h3>MCHP_QEI</h3>
                <p><strong>Quadrature Encoder Interface</strong></p>
                <p>Dedicated hardware quadrature decoder for dsPIC and PIC32 devices. Provides high-speed position and velocity measurement with minimal CPU overhead.</p>
                <ul class="feature-list">
                    <li>X2/X4 quadrature decoding</li>
                    <li>16-bit or 32-bit position counter</li>
                    <li>Index pulse and home reference</li>
                    <li>Velocity/period measurement</li>
                    <li>Digital filtering</li>
                </ul>
                <a href="encoders/qei.html">Learn More →</a>
            </div>

            <div class="block-card">
                <h3>MCHP_QDEC_SAMx</h3>
                <p><strong>Quadrature Decoder (SAM)</strong></p>
                <p>Uses TC (Timer/Counter) modules for quadrature decoding on SAM devices. Flexible configuration for position and speed measurement.</p>
                <ul class="feature-list">
                    <li>32-bit position counter</li>
                    <li>Revolution counter (multi-turn)</li>
                    <li>Speed measurement modes</li>
                    <li>Error detection (phase, missing pulse)</li>
                    <li>Direction change flag</li>
                </ul>
                <a href="encoders/qdec_samx.html">Learn More →</a>
            </div>

            <div class="block-card">
                <h3>MCHP_PDEC</h3>
                <p><strong>Position Decoder (SAM)</strong></p>
                <p>Specialized position decoder for Hall sensors and stepper motors on SAM E5x/E7x. Optimized for 3-phase BLDC motor applications.</p>
                <ul class="feature-list">
                    <li>Hall sensor interface (3-wire)</li>
                    <li>Quadrature encoder mode</li>
                    <li>Angular position (9-bit + resolution)</li>
                    <li>Revolution counter</li>
                    <li>Auto-correction for phase errors</li>
                </ul>
                <a href="encoders/pdec.html">Learn More →</a>
            </div>

            <div class="block-card">
                <h3>MCHP_CN</h3>
                <p><strong>Change Notification</strong></p>
                <p>Pin state change detection with edge timing measurement. Versatile for buttons, simple encoders, and pulse counting.</p>
                <ul class="feature-list">
                    <li>Multi-pin edge detection</li>
                    <li>Pulse width measurement</li>
                    <li>Period measurement</li>
                    <li>Wake from sleep capability</li>
                    <li>Simple encoder support</li>
                </ul>
                <a href="encoders/change_notification.html">Learn More →</a>
            </div>
        </div>
    </div>

    <div class="content-section">
        <h2>Block Selection Guide</h2>

        <h3>Choose the Right Block for Your Application</h3>

        <table class="comparison-table">
            <tr>
                <th>Feature</th>
                <th>MCHP_QEI</th>
                <th>MCHP_QDEC_SAMx</th>
                <th>MCHP_PDEC</th>
                <th>MCHP_CN</th>
            </tr>
            <tr>
                <td><strong>Device Families</strong></td>
                <td>dsPIC, PIC32MK</td>
                <td>SAM E5x/E7x/C2x</td>
                <td>SAM E5x/E7x</td>
                <td>All dsPIC, PIC24, PIC32</td>
            </tr>
            <tr>
                <td><strong>Quadrature Decoding</strong></td>
                <td><span class="yes">Hardware X2/X4</span></td>
                <td><span class="yes">Hardware X4</span></td>
                <td><span class="yes">Hardware X2/X4</span></td>
                <td>Software only (limited)</td>
            </tr>
            <tr>
                <td><strong>Hall Sensor Interface</strong></td>
                <td><span class="no">No</span></td>
                <td><span class="no">No</span></td>
                <td><span class="yes">Yes (3-wire)</span></td>
                <td>Software only</td>
            </tr>
            <tr>
                <td><strong>Position Counter</strong></td>
                <td>16/32-bit</td>
                <td>32-bit</td>
                <td>16-bit (9+7 to 9+14)</td>
                <td>Via timing measurement</td>
            </tr>
            <tr>
                <td><strong>Revolution Counter</strong></td>
                <td><span class="yes">Yes (32-bit only)</span></td>
                <td><span class="yes">Yes</span></td>
                <td><span class="yes">Yes</span></td>
                <td><span class="no">No</span></td>
            </tr>
            <tr>
                <td><strong>Velocity Measurement</strong></td>
                <td>Position diff + Period</td>
                <td>Position diff + Speed mode</td>
                <td>Position diff</td>
                <td>Period measurement</td>
            </tr>
            <tr>
                <td><strong>Index Pulse</strong></td>
                <td><span class="yes">Yes</span></td>
                <td><span class="yes">Yes</span></td>
                <td><span class="yes">Yes</span></td>
                <td>As regular input</td>
            </tr>
            <tr>
                <td><strong>Digital Filtering</strong></td>
                <td><span class="yes">Yes</span></td>
                <td><span class="yes">Yes</span></td>
                <td><span class="yes">Yes</span></td>
                <td>External only</td>
            </tr>
            <tr>
                <td><strong>Error Detection</strong></td>
                <td>Basic</td>
                <td><span class="yes">Phase, Missing Pulse</span></td>
                <td><span class="yes">Auto-correction</span></td>
                <td>None</td>
            </tr>
            <tr>
                <td><strong>Max Encoder Freq</strong></td>
                <td>Up to 23 MHz</td>
                <td>Up to MCK/4</td>
                <td>Up to GCLK/2</td>
                <td>Limited by ISR rate</td>
            </tr>
            <tr>
                <td><strong>CPU Overhead</strong></td>
                <td>Very Low</td>
                <td>Very Low</td>
                <td>Very Low</td>
                <td>Medium (ISR per edge)</td>
            </tr>
            <tr>
                <td><strong>Best For</strong></td>
                <td>Incremental encoders on dsPIC</td>
                <td>Encoders on SAM devices</td>
                <td>Hall sensors, BLDC motors</td>
                <td>Buttons, low-speed pulse counting</td>
            </tr>
        </table>
    </div>

    <div class="content-section">
        <h2>Encoder Types and Technologies</h2>

        <h3>Incremental Encoders</h3>
        <div class="info-box">
            <p><strong>Quadrature Output (A, B channels):</strong> Provides relative position with direction sensing. Most common type for motor control.</p>
            <ul>
                <li><strong>Resolution:</strong> Specified in PPR (Pulses Per Revolution)</li>
                <li><strong>X4 Decoding:</strong> Provides 4× PPR counts per revolution (both edges, both channels)</li>
                <li><strong>Index (Z):</strong> One pulse per revolution for absolute reference</li>
                <li><strong>Typical PPR:</strong> 100-10,000 (higher for precision applications)</li>
            </ul>
            <p><strong>Best Blocks:</strong> MCHP_QEI (dsPIC/PIC32), MCHP_QDEC_SAMx (SAM)</p>
        </div>

        <h3>Hall Effect Sensors</h3>
        <div class="info-box">
            <p><strong>3-Wire Digital Output (A, B, C):</strong> Used in BLDC motors for commutation and position feedback.</p>
            <ul>
                <li><strong>States:</strong> 6 valid states per electrical revolution</li>
                <li><strong>Resolution:</strong> 60° electrical (coarse), refined with PDEC to 9-bit per sector</li>
                <li><strong>Applications:</strong> BLDC/PMSM motor control, e-bikes, drones</li>
            </ul>
            <p><strong>Best Block:</strong> MCHP_PDEC (SAM E5x/E7x optimized for Hall sensors)</p>
        </div>

        <h3>Absolute Encoders</h3>
        <div class="info-box">
            <p><strong>Multi-bit Parallel or Serial Output:</strong> Provides absolute position without needing homing.</p>
            <ul>
                <li><strong>Interfaces:</strong> SSI, BiSS, Parallel binary/Gray code</li>
                <li><strong>Resolution:</strong> 12-bit to 25-bit (4096 to 33M positions per revolution)</li>
            </ul>
            <p><strong>Best Blocks:</strong> MCHP_SPI (for SSI/BiSS), MCHP_CN (for parallel Gray code)</p>
        </div>

        <h3>Encoder Connection Diagram</h3>
        <div class="diagram">
Incremental Encoder (Quadrature):
┌─────────────────┐
│  Encoder        │
│                 │
│  A  ────────────┼───→ QEA/QEIA (dsPIC QEI)
│  B  ────────────┼───→ QEB/QEIB         or
│  Z  ────────────┼───→ INDEX/QEINDX     PHA/PHB/IDX (SAM QDEC)
│  GND ───────────┼───→ GND
│  VCC ───────────┼───→ +5V or +12V
└─────────────────┘

Hall Sensor (BLDC Motor):
┌─────────────────┐
│  Hall Sensors   │
│                 │
│  HA ────────────┼───→ QDI0 (PDEC)
│  HB ────────────┼───→ QDI1
│  HC ────────────┼───→ QDI2
│  GND ───────────┼───→ GND
│  VCC ───────────┼───→ +5V (typical)
└─────────────────┘

Note: Add pull-up/pull-down resistors as needed
      Use shielded cable for noise immunity
        </div>
    </div>

    <div class="content-section">
        <h2>Common Encoder Calculations</h2>

        <h3>Position Resolution</h3>
        <div class="info-box">
            <p><strong>Incremental Encoder (X4 mode):</strong></p>
            <pre style="background-color: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto;">
// 500 PPR encoder in X4 mode
Counts_per_revolution = PPR × 4 = 500 × 4 = 2000
Resolution_degrees = 360° / 2000 = 0.18° per count
Resolution_radians = 2π / 2000 = 0.00314 rad per count

// Convert position counts to angle
Angle_degrees = (Position_counts / 2000) × 360°
Angle_radians = (Position_counts / 2000) × 2π
            </pre>

            <p><strong>Hall Sensor (BLDC Motor):</strong></p>
            <pre style="background-color: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto;">
// 4 pole pairs, 6 Hall states per electrical rev
Electrical_revs_per_mech_rev = Pole_pairs = 4
Hall_states_per_elec_rev = 6
Electrical_degrees_per_state = 360° / 6 = 60°
Mechanical_degrees_per_state = 60° / 4 = 15°

// With PDEC 9-bit interpolation (512 counts per sector)
Counts_per_elec_rev = 6 × 512 = 3072
Resolution_elec_deg = 360° / 3072 = 0.117° electrical
Resolution_mech_deg = 0.117° / 4 = 0.029° mechanical
            </pre>
        </div>

        <h3>Velocity Calculation</h3>
        <div class="info-box">
            <p><strong>Method 1: Position Difference (High Speed):</strong></p>
            <pre style="background-color: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto;">
// Sample encoder at fixed rate (e.g., 1 kHz)
Position_delta = Position_current - Position_previous;
Sample_rate = 1000; // Hz
Counts_per_rev = 2000;

// Calculate RPM
RPM = (Position_delta × Sample_rate × 60) / Counts_per_rev
RPM = (Position_delta × 1000 × 60) / 2000
RPM = Position_delta × 30

// Example: Position_delta = 100 counts
// RPM = 100 × 30 = 3000 RPM
            </pre>

            <p><strong>Method 2: Period Measurement (Low Speed):</strong></p>
            <pre style="background-color: #2d2d2d; color: #f8f8f2; padding: 15px; border-radius: 5px; overflow-x: auto;">
// Measure time between encoder pulses
Period_seconds = Period_counts × Timer_resolution;
Frequency_Hz = 1 / Period_seconds;

// Convert to RPM (2000 counts/rev encoder)
RPM = (Frequency_Hz × 60) / Counts_per_rev
RPM = (Frequency_Hz × 60) / 2000

// Example: Period = 10 ms (100 Hz pulse rate)
// Frequency = 100 Hz
// RPM = (100 × 60) / 2000 = 3 RPM
            </pre>
        </div>
    </div>

    <div class="content-section">
        <h2>Noise and Signal Integrity</h2>

        <h3>Common Noise Sources</h3>
        <ul>
            <li><strong>Electrical Noise:</strong> Motor PWM switching, EMI from power circuits</li>
            <li><strong>Mechanical Vibration:</strong> Bearing runout, shaft flex, coupling misalignment</li>
            <li><strong>Grounding Issues:</strong> Ground loops, floating references</li>
            <li><strong>Cable Issues:</strong> Unshielded cables, long cable runs, improper termination</li>
        </ul>

        <h3>Noise Mitigation Techniques</h3>
        <table class="comparison-table">
            <tr>
                <th>Technique</th>
                <th>Implementation</th>
                <th>Effectiveness</th>
            </tr>
            <tr>
                <td><strong>Shielded Cable</strong></td>
                <td>Use twisted-pair shielded cable, ground shield at one end only</td>
                <td>High (reduces EMI pickup)</td>
            </tr>
            <tr>
                <td><strong>Digital Filtering</strong></td>
                <td>Enable hardware digital filter in QEI/QDEC/PDEC blocks</td>
                <td>Medium to High</td>
            </tr>
            <tr>
                <td><strong>RC Filter</strong></td>
                <td>Add external RC low-pass filter (e.g., 1kΩ + 100nF) at MCU input</td>
                <td>Medium</td>
            </tr>
            <tr>
                <td><strong>Schmitt Trigger</strong></td>
                <td>Use encoder with differential output (RS-422) or add Schmitt trigger buffer</td>
                <td>High (provides hysteresis)</td>
            </tr>
            <tr>
                <td><strong>Proper Grounding</strong></td>
                <td>Single-point ground, separate analog/digital grounds, star grounding</td>
                <td>High</td>
            </tr>
            <tr>
                <td><strong>Isolation</strong></td>
                <td>Optocoupler isolation between encoder and MCU</td>
                <td>Very High (galvanic isolation)</td>
            </tr>
        </table>
    </div>

    <div class="content-section">
        <h2>Example Applications</h2>

        <h3>1. Servo Motor Position Control</h3>
        <p><strong>Hardware:</strong> 1000 PPR incremental encoder on servo motor</p>
        <p><strong>Blocks:</strong> MCHP_QEI (dsPIC) or MCHP_QDEC_SAMx (SAM)</p>
        <p><strong>Configuration:</strong> X4 mode (4000 counts/rev), index pulse for homing, position + velocity outputs</p>
        <p><strong>Resolution:</strong> 360° / 4000 = 0.09° per count</p>

        <h3>2. BLDC Motor with Hall Sensors</h3>
        <p><strong>Hardware:</strong> 3-wire Hall sensors (60° spacing), 8 pole motor (4 pole pairs)</p>
        <p><strong>Block:</strong> MCHP_PDEC (SAM E5x/E7x)</p>
        <p><strong>Configuration:</strong> Hall sensor mode, auto-correction enabled, revolution counter</p>
        <p><strong>Output:</strong> Electrical angle for FOC control, commutation sector for trapezoidal control</p>

        <h3>3. Linear Actuator Position Feedback</h3>
        <p><strong>Hardware:</strong> Magnetic encoder strip, 5 µm pitch (200 lines/mm)</p>
        <p><strong>Block:</strong> MCHP_QEI</p>
        <p><strong>Configuration:</strong> X4 mode, 32-bit signed position counter</p>
        <p><strong>Resolution:</strong> 5 µm / 4 = 1.25 µm per count</p>

        <h3>4. Stepper Motor Position Verification</h3>
        <p><strong>Hardware:</strong> Step/Direction signals from stepper driver</p>
        <p><strong>Block:</strong> MCHP_PDEC (Counter with direction mode) or MCHP_QEI (pulse counter mode)</p>
        <p><strong>Use Case:</strong> Verify actual steps taken, detect missed steps or stall condition</p>
    </div>

    <div class="content-section">
        <h2>Quick Reference</h2>

        <div class="note-box">
            <h3>Block Selection Flowchart</h3>
            <pre style="font-family: monospace; line-height: 1.4;">
Do you have an incremental encoder (A/B channels)?
├─ YES → Device family?
│         ├─ dsPIC/PIC32 → Use <strong>MCHP_QEI</strong>
│         └─ SAM         → Use <strong>MCHP_QDEC_SAMx</strong>
│
└─ NO  → Do you have Hall sensors?
          ├─ YES → Device family?
          │         ├─ SAM E5x/E7x → Use <strong>MCHP_PDEC</strong>
          │         └─ Other       → Use <strong>MCHP_CN</strong> (software decoding)
          │
          └─ NO  → Need pulse counting or button detection?
                    └─ Use <strong>MCHP_CN</strong> (Change Notification)
            </pre>
        </div>

        <div class="note-box">
            <h3>Encoder Troubleshooting Checklist</h3>
            <ul>
                <li>✓ Verify encoder power supply voltage (5V, 12V, or 24V)</li>
                <li>✓ Check A/B phase relationship (90° offset, use oscilloscope)</li>
                <li>✓ Confirm wiring: A→QEA, B→QEB, Z→INDEX</li>
                <li>✓ Enable digital filter if noise/jitter observed</li>
                <li>✓ Check encoder frequency vs. maximum input frequency</li>
                <li>✓ Verify index pulse polarity and match value settings</li>
                <li>✓ Use signed datatype for bidirectional motion</li>
                <li>✓ Enable modulo/wrap for continuous rotation applications</li>
            </ul>
        </div>
    </div>

    <div class="content-section">
        <h2>Related Documentation</h2>
        <ul>
            <li><a href="index.html"><strong>MCHP Blockset Home</strong></a> - Main documentation index</li>
            <li><strong>PWM Blocks</strong> - Motor drive outputs (complementary to encoder inputs)</li>
            <li><strong>ADC Blocks</strong> - Current sensing for motor control</li>
            <li><strong>Communication Blocks</strong> - Transmit encoder data via UART/CAN</li>
            <li><strong>Timer Blocks</strong> - Alternative pulse/frequency measurement</li>
        </ul>
    </div>

    <div class="content-section" style="background-color: #f8f9fa; border-top: 3px solid #667eea; margin-top: 40px;">
        <p><strong>See Also:</strong> <a href="index.html">MCHP Blockset Documentation</a> | <a href="../downloads.html">Examples & Downloads</a></p>
        <p style="color: #666; font-size: 0.9em;">Last Updated: 2024 | MCHP Blockset for MATLAB/Simulink</p>
    </div>
    </div>
</body>
</html>
