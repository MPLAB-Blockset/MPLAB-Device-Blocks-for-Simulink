<!DOCTYPE html>
<html>
<head>
    <title>MCHP_PWM_HS_FEP - MCHP Blockset</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="../../assets/css/navigation.css">
    <script src="../../assets/js/navigation.js"></script>
</head>
<body>
    <!-- Mobile Navigation Toggle -->
    <button class="nav-toggle" aria-label="Toggle navigation">☰</button>

    <!-- Left Navigation Panel -->
    <nav class="doc-nav-container">
        <div class="doc-nav-header">
            <a href="../../index.html">MCHP Blockset Docs</a>
        </div>
        <ul class="doc-nav-menu">
            <li class="nav-item">
                <a href="../../index.html" class="nav-link">Home</a>
            </li>

            <!-- Getting Started Section -->
            <li class="nav-item">
                <div class="nav-category">Getting Started <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../getting_started/overview.html" class="nav-link">Overview</a></li>
                    <li><a href="../../getting_started/installation.html" class="nav-link">Installation</a></li>
                    <li><a href="../../getting_started/quick_start.html" class="nav-link">Quick Start</a></li>
                    <li><a href="../../getting_started/board_templates.html" class="nav-link">Board Templates</a></li>
                    <li><a href="../../getting_started/supported_devices.html" class="nav-link">Supported Devices</a></li>
                </ul>
            </li>

            <!-- User Guide Section -->
            <li class="nav-item">
                <div class="nav-category">User Guide <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../user_guide/index.html" class="nav-link">User Guide Overview</a></li>
                    <li><a href="../../user_guide/code_generation.html" class="nav-link">Code Generation</a></li>
                    <li><a href="../../user_guide/external_mode.html" class="nav-link">External Mode</a></li>
                </ul>
            </li>

            <!-- Block Reference Section -->
            <li class="nav-item">
                <div class="nav-category">Block Reference <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../block_reference/index.html" class="nav-link">Block Reference Overview</a></li>
                </ul>
            </li>

            <!-- Examples Section -->
            <li class="nav-item">
                <div class="nav-category">Examples <span class="nav-category-icon">▼</span></div>
                <ul class="nav-list">
                    <li><a href="../../examples/field_weakening.html" class="nav-link">Field Weakening</a></li>
                </ul>
            </li>

            <!-- Release Notes -->
            <li class="nav-item">
                <a href="../../release_notes.html" class="nav-link">Release Notes</a>
            </li>
        </ul>
    </nav>

    <div class="doc-content-wrapper">
    <h1>MCHP_PWM_HS_FEP - High-Speed PWM with Fine Edge Positioning</h1>

    <!-- Block Icon -->
    <div class="block-image">
        <img src="../assets/images/blocks/pwm/PWM_HS_FEP.svg"
             alt="PWM_HS_FEP Block Icon"
             onerror="this.onerror=null; this.src='../assets/images/blocks/pwm/PWM_HS_FEP.png';">
        <div class="block-image-caption">
            MCHP_PWM_HS_FEP Block Icon
        </div>
    </div>

    <h2>Block Description</h2>
    <p>The MCHP_PWM_HS_FEP block provides state-of-the-art high-resolution PWM control for the latest dsPIC33C and dsPIC33A microcontroller families. This block features <strong>Fine Edge Positioning (FEP)</strong> capability, delivering up to <strong>16× enhanced timing resolution</strong> compared to standard PWM blocks.</p>

    <p>This advanced PWM peripheral is specifically designed for precision motor control, high-frequency power conversion, and applications demanding superior timing accuracy and reduced total harmonic distortion (THD).</p>

    <div class="note">
        <strong>Key Innovation:</strong> High-Resolution (HiRES) mode provides 16× finer edge placement, enabling ultra-precise duty cycle control critical for advanced motor control algorithms and low-ripple power supplies.
    </div>

    <h2>Supported Device Families</h2>

    <table class="chip-table">
        <tr>
            <th>Family</th>
            <th>Representative Chips</th>
            <th>TLC Variant</th>
            <th>HiRES Support</th>
            <th>PWM Synthesis Freq</th>
        </tr>
        <tr>
            <td><strong>dsPIC33C<br>(Andromeda)</strong></td>
            <td>33CK64MC105<br>33CK512MP608<br>33CK1024MP710<br>33CK256MC506</td>
            <td>V1_WAC07<br>(Andromeda)</td>
            <td>✅ YES<br>(HREN bit)</td>
            <td>Standard<br>(16-bit registers)</td>
        </tr>
        <tr>
            <td><strong>dsPIC33A<br>(Perseus)</strong></td>
            <td>33AK128MC106</td>
            <td>V3_STX04<br>(Perseus)</td>
            <td>❌ NO<br>(No HiRES)</td>
            <td>Standard<br>(32-bit registers)</td>
        </tr>
        <tr>
            <td><strong>dsPIC33A<br>(Pegasus)<br>(Serpens)<br>(BlueRidge)</strong></td>
            <td>33AK512MPS512<br>33AK1024MPS612<br>33AKV256GMS205<br>33AK128MPS103</td>
            <td>V4_STX32_21_33<br>(Pegasus-Serpens-BR)</td>
            <td>✅ YES<br>(HiRES bit)</td>
            <td>800 MHz (STX32)<br>400 MHz (STX21)<br>TBD (STX33)</td>
        </tr>
    </table>

    <h3>Peripheral Module Mapping</h3>
    <table>
        <tr>
            <th>Family</th>
            <th>DOS Module</th>
            <th>Description</th>
        </tr>
        <tr>
            <td>dsPIC33C</td>
            <td><code>DOS_01483_pwm_16bit</code></td>
            <td>16-bit PWM with HREN capability</td>
        </tr>
        <tr>
            <td>dsPIC33A (V3)</td>
            <td><code>DOS_04302_pwm_pc_upb_v3_dspic33a</code></td>
            <td>32-bit PWM, no HiRES (Perseus)</td>
        </tr>
        <tr>
            <td>dsPIC33A (V4)</td>
            <td><code>DOS_05226_pwm_pc_upb_v4_dspic33a</code></td>
            <td>32-bit PWM with HiRES (Pegasus, Serpens, BlueRidge)</td>
        </tr>
    </table>

    <h2>Key Features</h2>

    <table>
        <tr>
            <th>Feature</th>
            <th>33C WAC07</th>
            <th>33A V3 (STX04)</th>
            <th>33A V4 (STX32/21)</th>
            <th>Benefits</th>
        </tr>
        <tr>
            <td><strong>HiRES Mode</strong></td>
            <td>✅ YES</td>
            <td>❌ NO</td>
            <td>✅ YES</td>
            <td>16× enhanced resolution</td>
        </tr>
        <tr>
            <td><strong>Max Channels</strong></td>
            <td>Variable</td>
            <td>Variable</td>
            <td>12 max (STX32)<br>8 max (STX21)</td>
            <td>Multi-phase control</td>
        </tr>
        <tr>
            <td><strong>Register Width</strong></td>
            <td>16-bit</td>
            <td>32-bit</td>
            <td>32-bit</td>
            <td>Overflow protection</td>
        </tr>
        <tr>
            <td><strong>Dead Time</strong></td>
            <td>✅ YES</td>
            <td>✅ YES</td>
            <td>✅ YES</td>
            <td>Motor drive safety</td>
        </tr>
        <tr>
            <td><strong>ADC Triggers</strong></td>
            <td>✅ YES</td>
            <td>✅ YES</td>
            <td>✅ YES</td>
            <td>Synchronized sampling</td>
        </tr>
        <tr>
            <td><strong>Master/Slave</strong></td>
            <td>✅ YES</td>
            <td>✅ YES</td>
            <td>✅ YES</td>
            <td>Multi-channel coordination</td>
        </tr>
    </table>

    <h2>High-Resolution Mode Critical Requirements</h2>

    <div class="important">
        <h3>⚠️ MANDATORY High-Resolution Mode Constraints</h3>
        <p><strong>Reference:</strong> DS70005320, Section 4.1.3 - "High-Resolution PWM with Fine Edge Placement"</p>

        <h4>Primary Restriction (ALL Families):</h4>
        <blockquote>
            <strong>"High-Resolution mode CANNOT be used with frequency scaling or the clock divider."</strong>
        </blockquote>

        <h4>Required Configuration for HiRES Mode (HREN=1):</h4>
        <ol>
            <li><strong>CLKSEL[1:0] bits</strong> (PGxCONL[4:3]) MUST be set to <code>'01'</code>
                <ul>
                    <li>This selects <code>pwm_master_clk</code> DIRECTLY (no divider/scaling)</li>
                </ul>
            </li>
            <li><strong>pwm_master_clk frequency requirements:</strong>
                <ul>
                    <li><strong>dsPIC33C:</strong> MUST be 500 MHz for High-Resolution mode</li>
                    <li><strong>dsPIC33A:</strong> Refer to device datasheet timing requirements
                        <ul>
                            <li>STX32: 800 MHz typical</li>
                            <li>STX21: 400 MHz typical</li>
                        </ul>
                    </li>
                </ul>
            </li>
        </ol>
    </div>

    <h3>CLKSEL Bit Mapping and HiRES Compatibility</h3>
    <table>
        <tr>
            <th>CLKSEL[1:0]</th>
            <th>Clock Path</th>
            <th>HiRES Compatible?</th>
            <th>User Option</th>
        </tr>
        <tr>
            <td>00</td>
            <td>Off (no clock)</td>
            <td>❌ NO</td>
            <td>Not applicable</td>
        </tr>
        <tr>
            <td>01</td>
            <td>Direct (master clock)</td>
            <td>✅ YES</td>
            <td>"no scaling"</td>
        </tr>
        <tr>
            <td>10</td>
            <td>Divider circuit</td>
            <td>❌ NO (FORBIDDEN)</td>
            <td>"Use divider circuit" (no PLL)</td>
        </tr>
        <tr>
            <td>11</td>
            <td>Scaling circuit</td>
            <td>❌ NO (FORBIDDEN)</td>
            <td>"Use scaling circuit" (no PLL)</td>
        </tr>
    </table>

    <h3>Additional High-Resolution Constraints</h3>
    <table>
        <tr>
            <th>Constraint</th>
            <th>Applies To</th>
            <th>Reference</th>
        </tr>
        <tr>
            <td>Dual PWM mode cannot be used with Complementary Output in HiRES</td>
            <td>All families (HREN=1)</td>
            <td>DS70005320, Sect. 4.1.3</td>
        </tr>
        <tr>
            <td>Minimum duty cycle: <code>0x0020</code> (vs. <code>0x0008</code> standard)</td>
            <td>All families (HREN=1)</td>
            <td>DS70005349, Line 17978</td>
        </tr>
        <tr>
            <td>Minimum period: <code>0x0080</code> (vs. <code>0x0010</code> standard)</td>
            <td>All families (HREN=1)</td>
            <td>DS70005349, Line 18007</td>
        </tr>
        <tr>
            <td>Some register LSBs forced to 0 (PGxLEB, PGxPHASE, etc.)</td>
            <td>All families (HREN=1)</td>
            <td>DS70005320, Sect. 4.1.3.1</td>
        </tr>
    </table>

    <h2>Configuration Parameters</h2>

    <h3>Clock Configuration</h3>
    <table>
        <tr>
            <th>Parameter</th>
            <th>Description</th>
            <th>Options</th>
        </tr>
        <tr>
            <td><code>PWMx_ClockResolution</code></td>
            <td>Clock source and resolution mode</td>
            <td>
                • <code>no scaling</code> - Direct clock (HiRES compatible)<br>
                • <code>auto</code> - Automatic selection (non-PLL)<br>
                • <code>Use divider circuit</code> - Clock divider (NO HiRES)<br>
                • <code>Use scaling circuit</code> - Clock scaling (NO HiRES)
            </td>
        </tr>
        <tr>
            <td><code>PWMx_ECAM_ITB</code></td>
            <td>Time base and alignment mode</td>
            <td>
                • Edge aligned<br>
                • Center aligned - Symmetric<br>
                • Center aligned - Symmetric - Enhanced resolution<br>
                • Center aligned - Asymmetric with double update<br>
                • Center aligned - Asymmetric with simultaneous update<br>
                • Independent time base variations
            </td>
        </tr>
    </table>

    <h3>PWM Generator Configuration</h3>
    <table>
        <tr>
            <th>Parameter</th>
            <th>Description</th>
        </tr>
        <tr>
            <td><code>PWM_Channels</code></td>
            <td>Array of enabled PWM generator numbers (e.g., [1 2 3] for 3-phase motor)</td>
        </tr>
        <tr>
            <td><code>Period_Config</code></td>
            <td>Period value configuration (constant or block input)</td>
        </tr>
        <tr>
            <td><code>DutyCycle_Config</code></td>
            <td>Duty cycle configuration per channel</td>
        </tr>
        <tr>
            <td><code>PhaseShift</code></td>
            <td>Phase shift values for interleaved operation</td>
        </tr>
    </table>

    <h3>Dead Time and Protection</h3>
    <table>
        <tr>
            <th>Parameter</th>
            <th>Description</th>
        </tr>
        <tr>
            <td><code>DTC</code></td>
            <td>Dead Time Control mode:<br>
                • Disabled<br>
                • Positive dead time<br>
                • Negative dead time (edge aligned only)<br>
                • Positive dead time with compensation mode
            </td>
        </tr>
        <tr>
            <td><code>DeadTime_High</code></td>
            <td>Dead-time for high-side transitions (seconds)</td>
        </tr>
        <tr>
            <td><code>DeadTime_Low</code></td>
            <td>Dead-time for low-side transitions (seconds)</td>
        </tr>
    </table>

    <h3>Trigger and Synchronization</h3>
    <table>
        <tr>
            <th>Parameter</th>
            <th>Description</th>
        </tr>
        <tr>
            <td><code>SEVTCMP</code></td>
            <td>Special Event Compare value for primary ADC trigger</td>
        </tr>
        <tr>
            <td><code>TRIGx</code></td>
            <td>Additional trigger outputs (up to 3 per generator)</td>
        </tr>
        <tr>
            <td><code>MasterPWM</code></td>
            <td>Master PWM generator selection for multi-channel sync</td>
        </tr>
    </table>

    <h2>Block Inputs/Outputs</h2>

    <h3>Variable Block Inputs</h3>
    <p>Inputs are dynamically configured based on enabled options:</p>
    <ul>
        <li><code>Period</code> (uint16/uint32) - If period input enabled</li>
        <li><code>DutyCycle 1..N</code> (uint16/uint32) - For each enabled channel</li>
        <li><code>PhaseShift 1..N</code> (uint16/uint32) - If phase shift input enabled</li>
        <li><code>SEVTCMP</code> (uint16/uint32) - If dynamic special event trigger enabled</li>
        <li><code>TRIGx 1..N</code> (uint16/uint32) - If dynamic trigger values enabled</li>
        <li><code>DeadTimeH/L 1..N</code> (uint16) - If dynamic dead-time enabled</li>
    </ul>

    <h3>Variable Block Outputs</h3>
    <ul>
        <li><code>Trigger 1..N</code> (boolean) - Trigger output signals</li>
        <li><code>Status</code> (uint16) - PWM status information (if enabled)</li>
    </ul>

    <h2>Implementation Details</h2>

    <h3>Automatic Family Detection</h3>
    <p>The block automatically detects the chip family and selects the appropriate TLC implementation:</p>
    <pre><code>% TLC file selection logic:
if MCHP.modsrc.DOS_01483_pwm_16bit
    % Use V1_WAC07_Andromeda.tlc (dsPIC33C)
elseif MCHP.modsrc.DOS_04302_pwm_pc_upb_v3_dspic33a
    % Use V3_STX04_Perseus.tlc (dsPIC33A V3, no HiRES)
elseif MCHP.modsrc.DOS_05226_pwm_pc_upb_v4_dspic33a
    % Use V4_STX32_21_33_Pegasus-Serpens-BlueRidge.tlc (dsPIC33A V4, HiRES)
end
</code></pre>

    <h3>32-bit Overflow Protection</h3>
    <p>For 16-bit register families (dsPIC33C), the block uses 32-bit arithmetic internally to prevent overflow during calculations, then saturates to 16-bit before register writes.</p>

    <h3>HiRES Resolution Calculation</h3>
    <pre><code>% Standard PWM resolution:
Standard_Resolution = log2(FCY / (Prescaler * f_PWM));

% HiRES mode (16× enhancement):
HiRES_Resolution = log2(16 * FCY / (Prescaler * f_PWM));
HiRES_Resolution = Standard_Resolution + 4 bits;

% Example: 100 kHz PWM, FCY = 100 MHz:
% Standard: log2(100e6/100e3) = 10 bits
% HiRES:    log2(16*100e6/100e3) = 14 bits
</code></pre>

    <h2>Usage Examples</h2>

    <h3>Example 1: High-Precision 3-Phase Motor Control (HiRES Mode)</h3>
    <pre><code>% Target: dsPIC33AK512MPS512 (Pegasus)
% PWM frequency: 50 kHz
% HiRES enabled for maximum resolution

% Configuration:
PWMx_ClockResolution = 'no scaling';  % MANDATORY for HiRES
PWM_Channels = [1 2 3];                % 3-phase motor
PWMx_ECAM_ITB = 'Center aligned - Symmetric - Enhanced resolution';
DTC = 'Positive dead time';
DeadTime_High = 1e-6;                  % 1 µs
DeadTime_Low = 1e-6;                   % 1 µs

% Result: 14-bit duty cycle resolution
% Ultra-low THD for smooth torque control
</code></pre>

    <h3>Example 2: Interleaved Boost Converter (Phase Shift)</h3>
    <pre><code>% Target: dsPIC33CK256MP508 (Andromeda)
% 4 interleaved phases for ripple reduction

% Configuration:
PWM_Channels = [1 2 3 4];
PWMx_ECAM_ITB = 'Edge aligned - Independent time base';
Period = 1/200e3;  % 200 kHz per phase

% Phase shifts (90° electrical):
PhaseShift_1 = 0;
PhaseShift_2 = Period/4;
PhaseShift_3 = Period/2;
PhaseShift_4 = 3*Period/4;

% Effective output ripple frequency: 4 × 200 kHz = 800 kHz
</code></pre>

    <h3>Example 3: Dual ADC Sampling (Symmetric Center-Aligned)</h3>
    <pre><code>% Sample at PWM valley and peak for dual current measurement

% Configuration:
PWMx_ECAM_ITB = 'Center aligned - Symmetric';
Period = 1/20e3;  % 20 kHz

% Trigger 1: Valley (up-count complete)
SEVTCMP = Period/2;  % At peak of center-aligned PWM

% Trigger 2: Peak (down-count complete)
TRIG2 = 0;  % At valley of center-aligned PWM

% ADC block configuration:
% - ADC1 triggered by SEVTCMP
% - ADC2 triggered by TRIG2
% - Captures both peak and valley currents
</code></pre>

    <h3>Example 4: Asymmetric Center-Aligned (THD Optimization)</h3>
    <pre><code>% Use asymmetric center-aligned for harmonic shaping

% Configuration:
PWMx_ECAM_ITB = 'Center aligned - Asymmetric with double update';
Period = 1/30e3;  % 30 kHz

% Two duty cycle values per PWM cycle:
DutyCycle_Up = 0.48;    % During up-count
DutyCycle_Down = 0.52;  % During down-count

% Applications:
% - Spread spectrum modulation (EMI reduction)
% - Active harmonic cancellation
% - Ripple steering in multi-phase systems
</code></pre>

    <h2>PWM-ADC Synchronization</h2>

    <p>Proper synchronization between PWM generation and ADC sampling is critical for motor control and power conversion applications. The PWM module can trigger ADC conversions at precise timing points, ensuring current measurements occur when switching noise is minimal.</p>

    <h3>Scheduler Trigger Options</h3>

    <p>The MCHP Blockset supports multiple strategies for triggering the control algorithm execution, each with specific advantages:</p>

    <h4>Option 1: Timer-Based Trigger (Baseline)</h4>

    <picture>
        <source srcset="../assets/images/toolbox_concepts/synchronization/MCHP_TimeStep_0TrigTimer.svg" type="image/svg+xml">
        <img src="../assets/images/toolbox_concepts/synchronization/MCHP_TimeStep_0TrigTimer.png" alt="Timer-Based Trigger" style="max-width: 900px;">
    </picture>

    <p><strong>Configuration:</strong></p>
    <ul>
        <li>Independent timer generates periodic interrupts</li>
        <li>ADC and PWM operate independently</li>
        <li>Control algorithm executes at fixed timer rate</li>
    </ul>

    <p><strong>Use Cases:</strong></p>
    <ul>
        <li>Simple periodic control loops without strict timing requirements</li>
        <li>Applications where ADC/PWM timing flexibility is needed</li>
        <li>Testing and debugging (easy to change rates independently)</li>
    </ul>

    <p><strong>Limitations:</strong></p>
    <ul>
        <li>No guaranteed synchronization between PWM switching and ADC sampling</li>
        <li>Risk of sampling during PWM transitions (switching noise corruption)</li>
        <li>Separate timer consumes additional hardware resources</li>
    </ul>

    <h4>Option 2: Timer → ADC → Task (Improved Synchronization)</h4>

    <picture>
        <source srcset="../assets/images/toolbox_concepts/synchronization/MCHP_TimeStep_1TrigTimerADC.svg" type="image/svg+xml">
        <img src="../assets/images/toolbox_concepts/synchronization/MCHP_TimeStep_1TrigTimerADC.png" alt="Timer-ADC-Task Trigger" style="max-width: 900px;">
    </picture>

    <p><strong>Configuration:</strong></p>
    <ul>
        <li>Timer triggers ADC conversion start</li>
        <li>ADC end-of-conversion triggers control task execution</li>
        <li>Control algorithm executes immediately when sensor data is ready</li>
    </ul>

    <p><strong>Advantages:</strong></p>
    <ul>
        <li><strong>Deterministic latency</strong>: Task starts exactly when ADC conversion completes</li>
        <li><strong>Data freshness</strong>: Control algorithm uses most recent measurements</li>
        <li><strong>Reduced jitter</strong>: Eliminates polling overhead</li>
    </ul>

    <p><strong>Use Cases:</strong></p>
    <ul>
        <li>Applications requiring precise timing between measurement and computation</li>
        <li>Multi-rate control systems with independent ADC timing</li>
        <li>Systems where PWM frequency differs from control loop frequency</li>
    </ul>

    <h4>Option 3: PWM → ADC → Task (Motor Control Standard)</h4>

    <picture>
        <source srcset="../assets/images/toolbox_concepts/synchronization/MCHP_TimeStep_2TrigPWMADC.svg" type="image/svg+xml">
        <img src="../assets/images/toolbox_concepts/synchronization/MCHP_TimeStep_2TrigPWMADC.png" alt="PWM-ADC-Task Trigger" style="max-width: 900px;">
    </picture>

    <p><strong>Configuration:</strong></p>
    <ul>
        <li>PWM Special Event Trigger (SEVTCMP) starts ADC conversion</li>
        <li>ADC end-of-conversion triggers control task execution</li>
        <li>Control algorithm calculates new PWM duty cycle for next period</li>
    </ul>

    <p><strong>Key Benefits for Motor Control:</strong></p>
    <ul>
        <li><strong>Optimal sampling timing</strong>: Sample when PWM low-side FET is ON (minimizes switching noise)</li>
        <li><strong>Synchronized to PWM period</strong>: Control rate automatically matches PWM frequency</li>
        <li><strong>Phase current sensing</strong>: Sample during current flow through shunt resistor</li>
        <li><strong>Hardware coordination</strong>: No software overhead for synchronization</li>
    </ul>

    <p><strong>Typical SEVTCMP Timing (Center-Aligned PWM):</strong></p>
    <pre><code>% For center-aligned PWM, sample at valley (maximum current flow)
SEVTCMP = 0;  % Trigger at PWM valley

% Alternative: Sample at peak
SEVTCMP = Period;  % Trigger at PWM peak

% For edge-aligned PWM, sample mid-period
SEVTCMP = Period/2;  % Trigger at 50% duty cycle point</code></pre>

    <p><strong>Use Cases:</strong></p>
    <ul>
        <li><strong>Field-Oriented Control (FOC)</strong>: Phase current measurement for Clarke/Park transforms</li>
        <li><strong>BLDC motor control</strong>: Commutation with synchronized sensing</li>
        <li><strong>DC-DC converters</strong>: Inductor current sensing during ON-time</li>
        <li><strong>Inverter control</strong>: Output current monitoring synchronized to switching</li>
    </ul>

    <h4>Option 4: PWM → Multiple ADC Triggers → Task (Advanced)</h4>

    <picture>
        <source srcset="../assets/images/toolbox_concepts/synchronization/MCHP_TimeStep_3TrigPWMADC.svg" type="image/svg+xml">
        <img src="../assets/images/toolbox_concepts/synchronization/MCHP_TimeStep_3TrigPWMADC.png" alt="PWM Multiple ADC Triggers" style="max-width: 900px;">
    </picture>

    <p><strong>Configuration:</strong></p>
    <ul>
        <li>Multiple trigger points within single PWM period</li>
        <li>SEVTCMP + TRIG1/TRIG2 enable sequential ADC conversions</li>
        <li>Different sampling phases for comprehensive measurement</li>
        <li>Control task executes after all conversions complete</li>
    </ul>

    <p><strong>Advanced Use Cases:</strong></p>
    <ul>
        <li><strong>3-Phase motor control</strong>: Sample each phase current at different PWM timing
            <ul>
                <li>SEVTCMP: Phase A current (PWM valley)</li>
                <li>TRIG1: Phase B current (25% into period)</li>
                <li>TRIG2: Phase C current (75% into period)</li>
            </ul>
        </li>
        <li><strong>Dual current sensing</strong>: Capture both rising and falling edge currents for average calculation</li>
        <li><strong>Multi-level inverters</strong>: Sample at different switching states</li>
        <li><strong>Ripple analysis</strong>: Capture peak and valley for DC-link ripple measurement</li>
    </ul>

    <p><strong>Configuration Example (3-Phase FOC):</strong></p>
    <pre><code>% PWM Configuration:
PWMx_ECAM_ITB = 'Center aligned - Symmetric';
Period = 1/20e3;  % 20 kHz PWM

% Trigger Configuration:
SEVTCMP = 0;              % Trigger ADC1 at PWM valley (Phase A)
TRIG1 = Period/4;         % Trigger ADC2 at 25% (Phase B)
TRIG2 = 3*Period/4;       % Trigger ADC3 at 75% (Phase C)

% ADC Configuration:
% - ADC1 (Channel 0): Phase A current, triggered by SEVTCMP
% - ADC2 (Channel 1): Phase B current, triggered by TRIG1
% - ADC3 (Channel 2): Phase C current, triggered by TRIG2
% - All three conversions complete before control task executes</code></pre>

    <h3>Synchronization Best Practices</h3>

    <div class="note">
        <strong>Motor Control Recommendations:</strong>
        <ul>
            <li><strong>Always use PWM → ADC → Task</strong> for motor control applications</li>
            <li><strong>Set SEVTCMP timing carefully</strong>:
                <ul>
                    <li>Center-aligned: Sample at valley (SEVTCMP = 0) for maximum current amplitude</li>
                    <li>Edge-aligned: Sample mid-period (SEVTCMP = Period/2) to avoid edges</li>
                </ul>
            </li>
            <li><strong>Account for ADC conversion time</strong>: Ensure conversion completes before next PWM event</li>
            <li><strong>Match base sample time</strong>: Simulink base time step = PWM period (ensures proper code generation)</li>
            <li><strong>Verify trigger timing</strong>: Use Task State block to measure execution timing on oscilloscope</li>
        </ul>
    </div>

    <h3>Common Synchronization Issues and Solutions</h3>

    <table>
        <tr>
            <th>Issue</th>
            <th>Symptom</th>
            <th>Solution</th>
        </tr>
        <tr>
            <td><strong>Noisy current measurements</strong></td>
            <td>High-frequency spikes in ADC readings</td>
            <td>
                • Move SEVTCMP away from PWM edge transitions<br>
                • Increase ADC sampling time for settling<br>
                • Use center-aligned PWM with valley sampling
            </td>
        </tr>
        <tr>
            <td><strong>Task overrun</strong></td>
            <td>MCU Load > 100%, control instability</td>
            <td>
                • Reduce PWM frequency (increase period)<br>
                • Optimize algorithm (use fixed-point instead of float)<br>
                • Enable code replacement for DSP operations
            </td>
        </tr>
        <tr>
            <td><strong>Incorrect trigger timing</strong></td>
            <td>ADC samples at wrong point in PWM cycle</td>
            <td>
                • Verify SEVTCMP value calculation<br>
                • Check PWM alignment mode (edge vs center)<br>
                • Use oscilloscope to verify trigger output timing
            </td>
        </tr>
        <tr>
            <td><strong>Phase current mismatch</strong></td>
            <td>Sum of phase currents ≠ 0 (Kirchhoff violation)</td>
            <td>
                • Synchronize all phase current ADC triggers to same PWM point<br>
                • Verify ADC conversion times are identical<br>
                • Check for differential sampling delays
            </td>
        </tr>
    </table>

    <h3>Implementation in Simulink Model</h3>

    <p><strong>Step-by-Step Configuration:</strong></p>

    <ol>
        <li><strong>Configure PWM Block</strong>:
            <pre><code>% In PWM_HS_FEP block dialog:
PWMx_ECAM_ITB = 'Center aligned - Symmetric';
Period = 1/20e3;  % 20 kHz
SEVTCMP_Config = 'Constant';
SEVTCMP_Value = 0;  % Sample at valley</code></pre>
        </li>
        <li><strong>Configure ADC Block</strong>:
            <pre><code>% In ADC block dialog:
Trigger_Source = 'PWM Special Event';
PWM_Trigger_Select = 'PWM1 SEVTCMP';  % Match PWM generator
Sample_Time = 'Inherited';  % Triggers set ADC rate</code></pre>
        </li>
        <li><strong>Set Simulink Solver</strong>:
            <pre><code>% Configuration Parameters → Solver:
Solver = 'Fixed-step';
Fixed_step_size = 1/20e3;  % Match PWM period
Tasking_mode = 'Multitasking';  % For rate monotonic scheduler</code></pre>
        </li>
        <li><strong>Verify Timing</strong>:
            <ul>
                <li>Add Task State block to monitor control loop execution</li>
                <li>Add MCU Load block to verify CPU utilization < 80%</li>
                <li>Build and test on hardware with oscilloscope</li>
            </ul>
        </li>
    </ol>

    <h2>Troubleshooting</h2>

    <h3>HiRES Mode Not Working</h3>
    <div class="warning">
        <strong>Symptom:</strong> HiRES mode enabled but not achieving expected resolution
    </div>
    <p><strong>Checklist:</strong></p>
    <ul>
        <li>✅ <code>PWMx_ClockResolution</code> set to <code>"no scaling"</code> (MANDATORY)</li>
        <li>✅ pwm_master_clk configured correctly (500 MHz for 33C, per datasheet for 33A)</li>
        <li>✅ Period and duty cycle values meet minimum requirements (0x0080 period, 0x0020 duty)</li>
        <li>✅ Not using dual PWM + complementary output mode (incompatible with HiRES)</li>
    </ul>

    <h3>Invalid Clock Configuration Error</h3>
    <div class="important">
        <strong>Error:</strong> "HiRES mode cannot be used with divider or scaling circuit"
    </div>
    <p><strong>Solution:</strong> Change <code>PWMx_ClockResolution</code> to <code>"no scaling"</code>. The divider and scaling circuits are incompatible with High-Resolution mode per DS70005320 Section 4.1.3.</p>

    <h3>Backward Compatibility Warning</h3>
    <div class="note">
        <strong>Note:</strong> Old models using <code>"auto [PLL]"</code> option are automatically converted to <code>"auto"</code> (non-PLL) for compliance with HiRES constraints.
    </div>

    <h3>Duty Cycle Saturation</h3>
    <div class="warning">
        <strong>Warning:</strong> "Duty cycle value saturated to minimum 0x0020 in HiRES mode"
    </div>
    <p><strong>Cause:</strong> HiRES mode has higher minimum duty cycle than standard mode.</p>
    <p><strong>Solution:</strong> Ensure duty cycle commands ≥ 0x0020. For very low duty cycles, use standard resolution mode.</p>

    <h2>Related Blocks</h2>
    <ul>
        <li><a href="pwm_high_speed.html"><strong>MCHP_PWM_HighSpeed</strong></a> - High-speed PWM for dsPIC33C/CH/CK (older variant)</li>
        <li><a href="pwm_standard.html"><strong>MCHP_PWM</strong></a> - Standard PWM for dsPIC30F/33F/33E</li>
        <li><a href="mcpwm.html"><strong>MCHP_MCPWM</strong></a> - Motor Control PWM (advanced features)</li>
        <li><strong>MCHP_ADC</strong> - ADC with PWM trigger synchronization</li>
        <li><strong>MCHP_Master</strong> - Master block for clock configuration</li>
    </ul>

    <h2>See Also</h2>
    <ul>
        <li><a href="../peripheral_overview.html">Peripheral Block Overview</a></li>
        <li><a href="../motor_control_guide.html">Motor Control Application Guide</a></li>
        <li><a href="../../../examples/hires_pwm_examples.html">High-Resolution PWM Examples</a></li>
        <li><a href="https://www.microchip.com/DS70005320">DS70005320</a> - Family Reference Manual: High-Resolution PWM with Fine Edge Placement</li>
        <li><a href="https://www.microchip.com/DS70005591">DS70005591</a> - dsPIC33A Data Sheet (33AK512MPS512)</li>
        <li><a href="https://www.microchip.com/DS70005539">DS70005539</a> - dsPIC33A Data Sheet (33AK128MC106)</li>
        <li><a href="https://www.microchip.com/DS70005349">DS70005349</a> - dsPIC33C Data Sheet (33CK256MP508)</li>
    </ul>

    <hr>
    <p><small>Last updated: January 2025 | MCHP Blockset Documentation</small></p>
    </div>
</body>
</html>
